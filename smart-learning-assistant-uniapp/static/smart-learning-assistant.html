<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智学宝</title>
    <!-- 版本: 2024-01-28-v4 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* 启动页面样式 */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #ff6b6b, #feca57, #48cae4, #667eea);
            background-size: 400% 400%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            animation: gradientFlow 15s ease-in-out infinite;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        .splash-screen.fade-out {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .splash-content {
            max-width: 900px;
            width: 95%;
            text-align: center;
            color: white;
            position: relative;
            z-index: 2;
            animation: fadeInUp 1.2s ease-out;
            padding: 20px;
        }

        .splash-header {
            margin-bottom: 25px;
        }

        .splash-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-icon {
            font-size: 64px;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .logo-text {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #f0f8ff, #e6f3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .splash-subtitle {
            font-size: 20px;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .splash-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 18px;
            background: rgba(255, 255, 255, 0.15);
            padding: 25px 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* 动画将在nth-child中单独定义 */
            min-height: 120px;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
            position: relative;
            user-select: none;
        }

        .feature-item:nth-child(1) {
            animation: slideInUp 0.8s ease-out 0.2s both, gentleFloat 4s ease-in-out infinite 1.2s;
        }

        .feature-item:nth-child(2) {
            animation: slideInUp 0.8s ease-out 0.4s both, gentleFloat 4.5s ease-in-out infinite 1.4s;
        }

        .feature-item:nth-child(3) {
            animation: slideInUp 0.8s ease-out 0.6s both, gentleFloat 5s ease-in-out infinite 1.6s;
        }

        .feature-item:nth-child(4) {
            animation: slideInUp 0.8s ease-out 0.8s both, gentleFloat 4.2s ease-in-out infinite 1.8s;
        }

        .feature-item:hover {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .feature-item.clicked {
            transform: translateY(-15px) scale(1.08) rotateX(5deg) rotateY(2deg);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .feature-item.clicked .feature-icon {
            transform: scale(1.2) rotateZ(5deg);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-item.clicked .feature-title {
            transform: scale(1.05);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-item.clicked .feature-desc {
            transform: scale(1.02);
            opacity: 1;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-icon {
            font-size: 36px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-content {
            text-align: left;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-desc {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.5;
            color: #f0f8ff;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .splash-steps {
            margin-bottom: 25px;
        }

        .steps-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .steps-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: bounceIn 1s ease-out;
        }

        .step-item:nth-child(1) {
            animation-delay: 1s;
        }

        .step-item:nth-child(3) {
            animation-delay: 1.2s;
        }

        .step-item:nth-child(5) {
            animation-delay: 1.4s;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
            transition: transform 0.3s ease;
        }

        .step-number:hover {
            transform: scale(1.1);
        }

        .step-text {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
        }

        .step-arrow {
            font-size: 24px;
            opacity: 0.8;
            color: #fff;
            animation: float 2s ease-in-out infinite;
        }

        .splash-footer {
            margin-top: 20px;
        }

        .start-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #ff9ff3);
            border: none;
            padding: 18px 50px;
            border-radius: 50px;
            color: white;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto 25px;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            animation: buttonGlow 2s ease-in-out infinite alternate;
        }

        .start-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        .start-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .start-icon {
            font-size: 24px;
        }

        .splash-tip {
            font-size: 16px;
            opacity: 0.8;
            color: #f0f8ff;
            font-weight: 300;
        }

        .splash-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .bg-circle-1 {
            width: 300px;
            height: 300px;
            top: 5%;
            left: 5%;
            animation: floatSlow 12s ease-in-out infinite;
            animation-delay: 0s;
        }

        .bg-circle-2 {
            width: 200px;
            height: 200px;
            top: 60%;
            right: 10%;
            animation: floatSlow 10s ease-in-out infinite reverse;
            animation-delay: 2s;
        }

        .bg-circle-3 {
            width: 150px;
            height: 150px;
            bottom: 15%;
            left: 15%;
            animation: floatSlow 14s ease-in-out infinite;
            animation-delay: 4s;
        }

        .bg-circle-4 {
            width: 100px;
            height: 100px;
            top: 30%;
            right: 30%;
            animation: floatSlow 8s ease-in-out infinite reverse;
            animation-delay: 1s;
        }

        /* 启动页面动画效果 */
        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }

            25% {
                background-position: 100% 50%;
            }

            50% {
                background-position: 100% 100%;
            }

            75% {
                background-position: 50% 100%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes floatSlow {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            33% {
                transform: translateY(-15px) rotate(120deg);
            }

            66% {
                transform: translateY(-8px) rotate(240deg);
            }
        }

        @keyframes shimmer {

            0%,
            100% {
                opacity: 0.3;
                transform: translateX(-100%);
            }

            50% {
                opacity: 0.8;
                transform: translateX(100%);
            }
        }

        @keyframes buttonGlow {
            0% {
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            }

            100% {
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6);
            }
        }

        @keyframes cardPulse {
            0% {
                transform: translateY(-15px) scale(1.08) rotateX(5deg) rotateY(2deg);
            }

            50% {
                transform: translateY(-18px) scale(1.12) rotateX(8deg) rotateY(3deg);
            }

            100% {
                transform: translateY(-15px) scale(1.08) rotateX(5deg) rotateY(2deg);
            }
        }

        @keyframes gentleFloat {

            0%,
            100% {
                transform: translateY(0px) rotateX(0deg) rotateY(0deg);
            }

            25% {
                transform: translateY(-8px) rotateX(1deg) rotateY(-0.5deg);
            }

            50% {
                transform: translateY(-12px) rotateX(0deg) rotateY(1deg);
            }

            75% {
                transform: translateY(-6px) rotateX(-1deg) rotateY(-0.5deg);
            }
        }

        /* 主应用内容初始隐藏 */
        .main-app {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s ease-out;
        }

        .main-app.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 统计详情弹窗手机端优化 */
        @media (max-width: 768px) {
            .stats-detail-modal {
                padding: 10px;
            }

            .stats-detail-content {
                width: 95%;
                max-height: calc(100vh - 20px);
                border-radius: 8px;
            }

            .stats-detail-header {
                padding: 15px;
            }

            .stats-detail-header h3 {
                font-size: 16px;
            }

            .stats-detail-body {
                padding: 15px;
                max-height: calc(100vh - 100px);
            }

            .detail-item {
                padding: 10px;
                margin-bottom: 6px;
            }

            .detail-item-content {
                font-size: 14px;
            }
        }

        /* 启动页面手机端优化 */
        @media (max-width: 768px) {
            .logo-text {
                font-size: 28px;
            }

            .logo-icon {
                font-size: 48px;
            }

            .splash-subtitle {
                font-size: 18px;
            }

            .splash-features {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .feature-item {
                padding: 20px 15px;
                min-height: 90px;
            }

            .feature-icon {
                font-size: 28px;
            }

            .steps-container {
                flex-direction: column;
                gap: 20px;
            }

            .step-arrow {
                transform: rotate(90deg);
            }

            .start-button {
                padding: 15px 40px;
                font-size: 18px;
            }

            .steps-title {
                font-size: 20px;
            }

            .bg-circle-1 {
                width: 200px;
                height: 200px;
            }

            .bg-circle-2 {
                width: 150px;
                height: 150px;
            }
        }

        .container {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 10px !important;
            padding-top: 10px !important;
            /* 增加顶部间距44px + 原有10px */
            min-height: 100vh;
            position: relative;
        }

        /* 手机端优化：容器间距调整 */
        @media (max-width: 768px) {
            .container {
                padding: 8px 6px !important;
                padding-top: 0px !important;
                /* 手机端增加顶部间距44px + 原有8px */
            }
        }

        /* 学习历史缓存项样式 */
        .cache-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .cache-info-section {
            flex: 1;
            margin-right: 10px;
        }

        .cache-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        /* 手机端优化：学习历史布局 */
        @media (max-width: 768px) {
            .cache-header {
                flex-direction: column;
                align-items: stretch;
            }

            .cache-info-section {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .cache-actions {
                align-self: flex-start;
                flex-wrap: nowrap;
            }

            .cache-actions .button {
                flex: 1;
                min-width: 0;
                font-size: 11px;
                padding: 6px 8px;
            }

            .cache-meta {
                line-height: 1.4 !important;
                word-break: break-all;
            }
        }

        /* 智能学习仪表板 */
        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* 手机端优化：仪表板间距调整 */
        @media (max-width: 768px) {
            .dashboard {
                border-radius: 15px;
                padding: 20px 15px;
                margin-bottom: 20px;
            }
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        /* 确保状态按钮不与右上角测试模式按钮重叠 */
        @media (max-width: 768px) {
            .dashboard-header .status {
                margin-right: 0;
                /* 手机端状态按钮不需要额外右边距 */
            }
        }

        .dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* 手机端优化：统计卡片两行排列 */
        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        .dashboard-card {
            background: linear-gradient(135deg, #F8FAFC, #E2E8F0);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        /* 手机端优化：统计卡片紧凑布局 - 左右排列 */
        @media (max-width: 768px) {
            .dashboard-card {
                padding: 12px 10px;
                gap: 10px;
                flex-direction: row;
                align-items: center;
                min-height: 60px;
            }
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .clickable-card {
            cursor: pointer;
            user-select: none;
        }

        .clickable-card:hover {
            background: linear-gradient(135deg, #EDF2F7, #CBD5E0);
        }

        .clickable-card:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* 统计详情弹窗样式 */
        .stats-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .stats-detail-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: calc(100vh - 40px);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .stats-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            background: linear-gradient(135deg, #F8FAFC, #E2E8F0);
        }

        .stats-detail-header h3 {
            margin: 0;
            color: #1F2937;
            font-size: 18px;
            font-weight: 600;
        }

        .stats-detail-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6B7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .stats-detail-close:hover {
            background: #F3F4F6;
            color: #374151;
        }

        .stats-detail-body {
            padding: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #CBD5E0 #F7FAFC;
        }

        .stats-detail-body::-webkit-scrollbar {
            width: 6px;
        }

        .stats-detail-body::-webkit-scrollbar-track {
            background: #F7FAFC;
            border-radius: 3px;
        }

        .stats-detail-body::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 3px;
        }

        .stats-detail-body::-webkit-scrollbar-thumb:hover {
            background: #A0AEC0;
        }

        .detail-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #F9FAFB;
            border-radius: 8px;
            border-left: 4px solid #3B82F6;
            transition: all 0.2s ease;
        }

        .detail-item:hover {
            background: #F3F4F6;
            transform: translateX(4px);
        }

        .detail-item-icon {
            font-size: 16px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .detail-item-content {
            flex: 1;
        }

        .detail-item-title {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .detail-item-meta {
            font-size: 12px;
            color: #6B7280;
        }

        .detail-item-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-answered {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-unanswered {
            background: #FEF3C7;
            color: #92400E;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6B7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 14px;
            color: #9CA3AF;
        }

        .clickable-detail-item {
            cursor: pointer;
            position: relative;
        }

        .clickable-detail-item:hover {
            background: #F3F4F6;
        }

        .detail-item-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .clickable-detail-item:hover .detail-item-arrow {
            transform: translateY(-50%) translateX(2px);
        }

        .clickable-answer-title {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clickable-answer-title:hover {
            color: #3B82F6;
        }

        .answer-toggle-icon {
            font-size: 12px;
            color: #9CA3AF;
            margin-left: 8px;
            transition: transform 0.2s ease;
        }

        .answer-preview,
        .answer-full {
            background: #F9FAFB;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #E5E7EB;
        }

        .answer-full {
            border-left-color: #3B82F6;
        }

        .dashboard-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 手机端优化：图标尺寸调整 */
        @media (max-width: 768px) {
            .dashboard-icon {
                width: 35px;
                height: 35px;
                font-size: 18px;
                flex-shrink: 0;
            }
        }

        .dashboard-info {
            flex: 1;
        }

        .dashboard-number {
            font-size: 24px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 4px;
        }

        .dashboard-label {
            font-size: 12px;
            color: #6B7280;
            font-weight: 500;
        }

        /* 手机端优化：文字尺寸调整 */
        @media (max-width: 768px) {
            .dashboard-info {
                flex: 1;
                text-align: left;
            }

            .dashboard-number {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .dashboard-label {
                font-size: 11px;
                line-height: 1.2;
            }
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* 手机端优化：按钮大按钮样式，一行四个 */
        @media (max-width: 768px) {
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin: 15px 0;
            }

            .quick-action-btn {
                padding: 12px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 60px;
                line-height: 1.2;
                text-align: center;
                white-space: nowrap;
            }

            .quick-action-btn .btn-icon {
                font-size: 16px;
                margin-bottom: 4px;
                display: block;
            }

            .quick-action-btn .btn-text {
                font-size: 10px;
                display: block;
            }
        }

        .quick-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
        }

        /* 付费相关样式 */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
        }

        .payment-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            text-align: center;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .payment-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6B7280;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .payment-close:hover {
            background: #F3F4F6;
            color: #374151;
        }

        /* 购买主题套餐弹窗手机端优化 */
        @media (max-width: 768px) {
            .payment-modal {
                padding: 15px;
            }

            .payment-content {
                padding: 25px 20px;
                border-radius: 15px;
                max-width: none;
                width: 100%;
                max-height: calc(100vh - 30px);
            }

            .payment-tabs {
                gap: 4px;
            }

            .payment-tab {
                padding: 10px 6px;
                font-size: 12px;
                min-width: 70px;
                flex: 1;
            }

            .qr-code {
                width: 180px;
                height: 180px;
            }

            .payment-title {
                font-size: 20px;
                margin-top: 10px;
            }
        }

        .payment-title {
            font-size: 24px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 15px;
        }

        .payment-subtitle {
            color: #6B7280;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .payment-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .payment-tab {
            padding: 12px 8px;
            border: 2px solid #E5E7EB;
            background: #F9FAFB;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s ease;
            text-align: center;
            line-height: 1.3;
            min-width: 80px;
            flex: 1;
        }

        .payment-tab:hover {
            border-color: #1E3A8A;
            transform: translateY(-1px);
        }

        .payment-tab.active {
            background: #1E3A8A !important;
            color: white !important;
            border-color: #1E3A8A !important;
        }

        .qr-container {
            margin: 20px 0;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F9FAFB;
            font-size: 14px;
            color: #6B7280;
        }

        .payment-amount {
            font-size: 18px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 10px;
        }

        .payment-note {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 20px;
        }

        .payment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .payment-input:focus {
            outline: none;
            border-color: #3B82F6;
        }

        .unlock-badge {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .locked-answer {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border: 2px dashed #F59E0B;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            color: #92400E;
        }

        .locked-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .locked-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .locked-subtitle {
            font-size: 14px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .unlock-btn {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .unlock-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .locked-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .credits-info {
            background: linear-gradient(135deg, #EBF8FF, #DBEAFE);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #93C5FD;
        }

        .credits-number {
            font-size: 24px;
            font-weight: bold;
            color: #1E3A8A;
        }

        .credits-label {
            font-size: 14px;
            color: #3B82F6;
            margin-top: 5px;
        }

        /* 问题状态图标 */
        .question-status-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .free-icon {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .paid-icon {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .answered-icon {
            background: linear-gradient(135deg, #3B82F6, #1E40AF);
            color: white;
        }

        /* 半隐藏式测试模式切换按钮 */
        .test-mode-toggle-container {
            position: fixed;
            top: 60px;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
        }

        .test-mode-toggle {
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px 0 0 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            white-space: nowrap;
            overflow: hidden;
            width: 40px;
            /* 收起状态只显示图标 */
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .test-mode-toggle.expanded {
            width: 140px;
            /* 展开状态显示完整文字 */
            padding: 8px 16px 8px 12px;
        }

        .test-mode-toggle:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .test-mode-toggle.free-mode {
            background: rgba(16, 185, 129, 0.5);
        }

        .test-mode-toggle.free-mode:hover {
            background: rgba(16, 185, 129, 0.7);
        }

        .test-mode-toggle.free-mode.expanded {
            background: rgba(16, 185, 129, 0.6);
        }

        .toggle-icon {
            font-size: 14px;
            margin-right: 6px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .test-mode-toggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .toggle-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 11px;
            white-space: nowrap;
        }

        .test-mode-toggle.expanded .toggle-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* 手机端优化 */
        @media (max-width: 768px) {
            .test-mode-toggle-container {
                top: 50px;
            }

            .test-mode-toggle {
                width: 36px;
                padding: 6px 10px;
                font-size: 11px;
            }

            .test-mode-toggle.expanded {
                width: 120px;
                padding: 6px 12px 6px 10px;
            }

            .toggle-icon {
                font-size: 12px;
                margin-right: 4px;
            }

            .toggle-text {
                font-size: 10px;
            }
        }

        /* 平板端优化 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .test-mode-toggle {
                width: 44px;
                padding: 10px 14px;
            }

            .test-mode-toggle.expanded {
                width: 160px;
                padding: 10px 18px 10px 14px;
            }

            .toggle-icon {
                font-size: 16px;
                margin-right: 8px;
            }

            .toggle-text {
                font-size: 13px;
            }
        }

        /* 添加一个微妙的阴影效果 */
        .test-mode-toggle-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .test-mode-toggle.expanded+.test-mode-toggle-container::before {
            opacity: 1;
        }

        /* 自定义确认对话框 */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .confirm-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        .confirm-title {
            font-size: 20px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 15px;
        }

        .confirm-message {
            color: #4B5563;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn.primary {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
        }

        .confirm-btn.secondary {
            background: #F3F4F6;
            color: #6B7280;
        }

        .confirm-btn:hover {
            transform: translateY(-1px);
        }

        /* 收起按钮样式 */
        .collapse-btn {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .collapse-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        /* 自定义确认对话框样式 */
        .custom-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .custom-confirm-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: confirmSlideIn 0.3s ease;
        }

        @keyframes confirmSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .custom-confirm-title {
            font-size: 20px;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 15px;
        }

        .custom-confirm-message {
            color: #4B5563;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .custom-confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .custom-confirm-btn.primary {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
        }

        .custom-confirm-btn.secondary {
            background: #F3F4F6;
            color: #6B7280;
        }

        .custom-confirm-btn:hover {
            transform: translateY(-1px);
        }

        /* 问题卡片可点击样式 */
        .question-card.clickable {
            cursor: pointer;
        }

        .question-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        /* 问题卡片动画效果 */
        .question-card {
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease forwards;
        }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .title {
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        /* 手机端进一步缩小标题 */
        @media (max-width: 768px) {
            .title {
                font-size: 18px;
            }
        }

        .subtitle {
            font-size: 16px;
            color: #6B7280;
            margin-bottom: 15px;
        }

        .status {
            display: inline-block;
            padding: 6px 12px;
            background: #10B981;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .card {
            background: rgba(255, 255, 255, 0.95) !important;
            padding: 12px !important;
            border-radius: 15px;
            margin-bottom: 12px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6B7280;
        }

        .tab.active {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
        }

        /* 手机端优化：标签页按钮大按钮样式，一行四个 */
        @media (max-width: 768px) {
            .tabs {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin: 20px 0;
                padding: 0 10px;
            }

            .tab {
                padding: 12px 6px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 65px;
                line-height: 1.2;
                text-align: center;
                white-space: nowrap;
            }

            .tab .tab-icon {
                font-size: 18px;
                margin-bottom: 4px;
                display: block;
            }

            .tab .tab-text {
                font-size: 10px;
                display: block;
            }
        }

        .input-group {
            margin-bottom: 18px;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1F2937;
            font-size: 14px;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 14px;
            background: #F9FAFB;
            transition: all 0.3s ease;
        }

        .input:focus {
            outline: none;
            border-color: #3B82F6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .button {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.2);
        }

        .button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3);
        }

        .button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
            transform: none;
        }

        .button-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .button-secondary {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .button-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        /* 回到顶部按钮 */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-to-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.6);
        }

        .back-to-top.show {
            display: flex;
        }

        .industry-container {
            margin-bottom: 20px;
        }

        .industry-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(135deg, #F8FAFC, #E2E8F0);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .industry-header:hover {
            background: linear-gradient(135deg, #EBF8FF, #DBEAFE);
            transform: translateY(-1px);
        }

        .industry-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
        }

        .industry-toggle {
            font-size: 12px;
            color: #6B7280;
            transition: transform 0.3s ease;
        }

        .industry-toggle.expanded {
            transform: rotate(180deg);
        }

        .industry-topics {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            padding: 0 15px 15px;
        }

        .industry-topics.expanded {
            display: grid;
        }

        .topic-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 13px;
            position: relative;
        }

        .topic-item:hover {
            background: linear-gradient(135deg, #EBF8FF, #DBEAFE);
            border-color: #3B82F6;
            transform: translateY(-1px);
        }

        .topic-item.cached::after {
            content: '●';
            position: absolute;
            top: 5px;
            right: 8px;
            color: #10B981;
            font-size: 10px;
        }

        .questions-container {
            display: none;
        }

        .question-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #6B7280;
            transition: all 0.3s ease;
            position: relative;
        }

        .question-card.answered {
            border-left-color: #10B981;
            background: linear-gradient(135deg, #F0FDF4, #ECFDF5);
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }

        .question-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            display: none;
        }

        .question-card.answered .question-status {
            display: block;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 15px;
            color: #1F2937;
            font-weight: 500;
            flex: 1;
            margin-right: 15px;
            line-height: 1.5;
        }

        .question-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .question-meta {
            font-size: 12px;
            color: #6B7280;
            flex: 1;
        }

        .category-badge {
            background: #E0F2FE;
            color: #0369A1;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-right: 8px;
            font-weight: 500;
        }

        .answer-container {
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE) !important;
            padding: 10px !important;
            border-radius: 10px;
            margin-top: 8px !important;
            display: none;
            border: 1px solid #BAE6FD;
        }

        .answer-container.expanded {
            display: block;
        }

        .answer-text {
            line-height: 1.7;
            color: #1F2937;
            font-size: 14px;
        }

        /* Markdown样式 */
        .answer-text h1,
        .answer-text h2,
        .answer-text h3 {
            margin: 16px 0 8px 0;
            color: #1E3A8A;
        }

        .answer-text h1 {
            font-size: 18px;
        }

        .answer-text h2 {
            font-size: 16px;
        }

        .answer-text h3 {
            font-size: 14px;
        }

        .answer-text p {
            margin: 8px 0;
        }

        .answer-text ul,
        .answer-text ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .answer-text li {
            margin: 4px 0;
        }

        .answer-text code {
            background: #F3F4F6;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .answer-text pre {
            background: #F3F4F6;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .answer-text blockquote {
            border-left: 4px solid #3B82F6;
            padding-left: 12px;
            margin: 8px 0;
            color: #6B7280;
            font-style: italic;
        }

        .answer-text strong {
            font-weight: 600;
            color: #1F2937;
        }

        .answer-text em {
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 25px;
            color: #374151;
            font-size: 15px;
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
            border-radius: 12px;
            border: 1px solid #BAE6FD;
            margin: 10px 0;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .loading-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }

        .loading-text {
            font-weight: 500;
            color: #1E40AF;
        }

        .loading-subtitle {
            font-size: 13px;
            color: #6B7280;
            opacity: 0.8;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background-color: #3B82F6;
            border-radius: 50%;
            animation: wave 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes wave {

            0%,
            60%,
            100% {
                transform: initial;
                opacity: 1;
            }

            30% {
                transform: translateY(-15px);
                opacity: 0.7;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .thinking-progress {
            width: 100%;
            height: 4px;
            background-color: #E5E7EB;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .thinking-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #1E40AF, #3B82F6);
            background-size: 200% 100%;
            animation: progress-flow 2s linear infinite;
        }

        @keyframes progress-flow {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #3B82F6;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.error {
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            color: #DC2626;
            border: 1px solid #F87171;
        }

        .message.success {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            border: 1px solid #34D399;
        }

        .message.loading {
            background: linear-gradient(135deg, #E0F2FE, #BAE6FD);
            color: #0369A1;
            border: 1px solid #38BDF8;
        }

        .hidden {
            display: none;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #1E3A8A;
        }

        .stat-label {
            font-size: 12px;
            color: #6B7280;
            margin-top: 3px;
        }

        .load-more {
            text-align: center;
            padding: 20px;
        }

        .provider-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .provider-btn {
            padding: 10px 16px;
            border: 2px solid #E5E7EB;
            background: #F9FAFB;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6B7280;
        }

        .provider-btn.active {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            border-color: #1E3A8A;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .provider-btn.nvidia-btn {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-color: #10B981;
            position: relative;
        }

        .provider-btn.nvidia-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }

        .provider-btn.nvidia-btn.active {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 15px;
            text-align: center;
        }

        .cache-info {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            color: #166534;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #3B82F6;
        }

        .history-question {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .history-answer {
            color: #4B5563;
            font-size: 14px;
            line-height: 1.6;
            background: #F9FAFB;
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .history-meta {
            font-size: 12px;
            color: #6B7280;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .industry-topics {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .industry-topics {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .question-footer {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .question-meta {
                flex: 1;
                margin-bottom: 0;
            }

            .question-actions {
                flex-shrink: 0;
            }

            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
        }



        .splash-content {
            max-width: 900px;
            width: 95%;
            text-align: center;
            color: white;
            position: relative;
            z-index: 2;
            animation: fadeInUp 1.2s ease-out;
            padding: 20px;
        }

        .splash-header {
            margin-bottom: 40px;
        }

        .splash-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            font-size: 48px;
            animation: pulse 2s infinite;
        }

        .logo-text {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #f0f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .splash-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .splash-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .feature-content {
            text-align: left;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .feature-desc {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .splash-steps {
            margin-bottom: 40px;
        }

        .steps-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .steps-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .step-text {
            font-size: 14px;
            opacity: 0.9;
        }

        .step-arrow {
            font-size: 20px;
            opacity: 0.7;
        }

        .splash-footer {
            margin-top: 30px;
        }

        .start-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto 20px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }

        .start-icon {
            font-size: 20px;
        }

        .splash-tip {
            font-size: 14px;
            opacity: 0.7;
        }

        .splash-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .bg-circle-1 {
            width: 200px;
            height: 200px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .bg-circle-2 {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 15%;
            animation-delay: 2s;
        }

        .bg-circle-3 {
            width: 100px;
            height: 100px;
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 手机端优化 */
        @media (max-width: 768px) {
            .logo-text {
                font-size: 24px;
            }

            .logo-icon {
                font-size: 36px;
            }

            .splash-subtitle {
                font-size: 16px;
            }

            .splash-features {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .feature-item {
                padding: 15px;
            }

            .feature-icon {
                font-size: 24px;
            }

            .steps-container {
                flex-direction: column;
                gap: 15px;
            }

            .step-arrow {
                transform: rotate(90deg);
            }

            .start-button {
                padding: 12px 30px;
                font-size: 16px;
            }
        }

        /* 启动页面完整样式补充 */
        .splash-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 18px;
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            transition: all 0.4s ease;
            animation: slideInUp 0.8s ease-out;
        }

        .feature-item:nth-child(1) {
            animation-delay: 0.2s;
        }

        .feature-item:nth-child(2) {
            animation-delay: 0.4s;
        }

        .feature-item:nth-child(3) {
            animation-delay: 0.6s;
        }

        .feature-item:nth-child(4) {
            animation-delay: 0.8s;
        }

        .feature-item:hover {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .splash-steps {
            margin-bottom: 50px;
        }

        .steps-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .steps-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: bounceIn 1s ease-out;
        }

        .step-item:nth-child(1) {
            animation-delay: 1s;
        }

        .step-item:nth-child(3) {
            animation-delay: 1.2s;
        }

        .step-item:nth-child(5) {
            animation-delay: 1.4s;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
            transition: transform 0.3s ease;
        }

        .step-number:hover {
            transform: scale(1.1);
        }

        .step-text {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
        }

        .step-arrow {
            font-size: 24px;
            opacity: 0.8;
            color: #fff;
            animation: float 2s ease-in-out infinite;
        }

        .splash-footer {
            margin-top: 40px;
        }

        .start-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #ff9ff3);
            border: none;
            padding: 18px 50px;
            border-radius: 50px;
            color: white;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto 25px;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            animation: buttonGlow 2s ease-in-out infinite alternate;
        }

        .start-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        .start-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .start-icon {
            font-size: 24px;
        }

        .splash-tip {
            font-size: 16px;
            opacity: 0.8;
            color: #f0f8ff;
            font-weight: 300;
        }

        /* 启动页面手机端优化 */
        @media (max-width: 768px) {
            .splash-screen {
                padding: 20px 0;
                align-items: flex-start;
                overflow-y: auto;
            }

            .splash-content {
                width: 95%;
                padding: 10px;
                max-width: none;
                margin-top: 10px;
            }

            .splash-header {
                margin-bottom: 25px;
            }

            .splash-logo {
                gap: 12px;
                margin-bottom: 15px;
            }

            .splash-logo .logo-text {
                font-size: 22px;
                line-height: 1.2;
            }

            .splash-logo .logo-icon {
                font-size: 40px;
            }

            .splash-subtitle {
                font-size: 15px;
                margin-bottom: 10px;
                line-height: 1.4;
            }

            .splash-features {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 25px;
            }

            .feature-item {
                padding: 15px;
                gap: 12px;
                border-radius: 15px;
            }

            .feature-icon {
                font-size: 28px;
            }

            .feature-title {
                font-size: 15px;
                margin-bottom: 4px;
            }

            .feature-desc {
                font-size: 12px;
                line-height: 1.3;
            }

            .splash-steps {
                margin-bottom: 25px;
            }

            .steps-title {
                font-size: 16px;
                margin-bottom: 20px;
            }

            .steps-container {
                flex-direction: row;
                gap: 15px;
                justify-content: space-around;
                flex-wrap: nowrap;
            }

            .step-item {
                gap: 8px;
                flex: 1;
                min-width: 0;
            }

            .step-number {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .step-text {
                font-size: 12px;
                text-align: center;
            }

            .step-arrow {
                transform: none;
                font-size: 16px;
                flex-shrink: 0;
            }

            .splash-footer {
                margin-top: 20px;
            }

            .start-button {
                padding: 12px 30px;
                font-size: 15px;
                gap: 8px;
            }

            .start-icon {
                font-size: 18px;
            }

            .splash-tip {
                font-size: 13px;
                line-height: 1.4;
            }

            .splash-auto-start {
                margin-top: 12px !important;
                font-size: 12px !important;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .splash-screen {
                padding: 15px 0;
            }

            .splash-content {
                width: 98%;
                padding: 8px;
                margin-top: 15px;
            }

            .splash-header {
                margin-bottom: 20px;
            }

            .splash-logo .logo-text {
                font-size: 18px;
            }

            .splash-logo .logo-icon {
                font-size: 32px;
            }

            .splash-subtitle {
                font-size: 13px;
            }

            .splash-features {
                margin-bottom: 20px;
                gap: 10px;
            }

            .feature-item {
                padding: 12px;
            }

            .feature-icon {
                font-size: 24px;
            }

            .feature-title {
                font-size: 14px;
            }

            .feature-desc {
                font-size: 11px;
            }

            .splash-steps {
                margin-bottom: 20px;
            }

            .steps-title {
                font-size: 14px;
                margin-bottom: 15px;
            }

            .step-number {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .step-text {
                font-size: 11px;
            }

            .step-arrow {
                font-size: 14px;
            }

            .splash-footer {
                margin-top: 15px;
            }

            .start-button {
                padding: 10px 25px;
                font-size: 14px;
            }

            .splash-tip {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- 启动页面海报 -->
    <div class="splash-screen" id="splash-screen">
        <div class="splash-content">
            <div class="splash-header">
                <div class="splash-logo">
                    <div class="logo-icon">🧠</div>
                    <div class="logo-text">问题驱动学习智能助手</div>
                </div>
                <div class="splash-subtitle">想用AI学习却不知如何提问？</div>
            </div>

            <div class="splash-features">
                <div class="feature-item">
                    <div class="feature-icon">🎯</div>
                    <div class="feature-content">
                        <div class="feature-title">智能问题生成</div>
                        <div class="feature-desc">AI根据学习主题自动生成个性化问题，覆盖基础到进阶各个层次</div>
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">💡</div>
                    <div class="feature-content">
                        <div class="feature-title">流式答案输出</div>
                        <div class="feature-desc">实时生成详细答案，支持多领域专业解答，让学习更加生动</div>
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">📚</div>
                    <div class="feature-content">
                        <div class="feature-title">学习记录管理</div>
                        <div class="feature-desc">自动保存学习进度，智能统计学习数据，随时回顾知识要点</div>
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">🌟</div>
                    <div class="feature-content">
                        <div class="feature-title">多领域覆盖</div>
                        <div class="feature-desc">支持技术、文学、旅游、商业等各个领域，满足不同学习需求</div>
                    </div>
                </div>
            </div>

            <div class="splash-steps">
                <div class="steps-title">三步开始学习</div>
                <div class="steps-container">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-text">输入学习主题</div>
                    </div>
                    <div class="step-arrow">→</div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-text">AI生成问题</div>
                    </div>
                    <div class="step-arrow">→</div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-text">获得详细答案</div>
                    </div>
                </div>
            </div>

            <div class="splash-footer">
                <button class="start-button" onclick="hideSplashScreen()">
                    <span class="start-icon">🚀</span>
                    <span class="start-text">开始学习之旅</span>
                </button>
                <div class="splash-tip">若配置自有API密钥可享受无限制使用体验</div>
            </div>
        </div>

        <div class="splash-background">
            <div class="bg-circle bg-circle-1"></div>
            <div class="bg-circle bg-circle-2"></div>
            <div class="bg-circle bg-circle-3"></div>
        </div>
    </div>

    <!-- 主应用内容 -->
    <div class="main-app" id="main-app">
        <div class="container">
            <!-- 智能学习仪表板 -->
            <div class="dashboard">
                <div class="dashboard-header">
                    <h1 class="title">🧠 问题驱动学习助手</h1>
                    <div class="status" id="api-status">未配置API</div>
                </div>

                <div class="dashboard-content">
                    <div class="dashboard-card clickable-card" onclick="showTopicsDetail()">
                        <div class="dashboard-icon">📊</div>
                        <div class="dashboard-info">
                            <div class="dashboard-number" id="total-topics">0</div>
                            <div class="dashboard-label">学习主题</div>
                        </div>
                    </div>

                    <div class="dashboard-card clickable-card" onclick="showQuestionsDetail()">
                        <div class="dashboard-icon">❓</div>
                        <div class="dashboard-info">
                            <div class="dashboard-number" id="total-questions-dashboard">0</div>
                            <div class="dashboard-label">总问题数</div>
                        </div>
                    </div>

                    <div class="dashboard-card clickable-card" onclick="showAnsweredDetail()">
                        <div class="dashboard-icon">✅</div>
                        <div class="dashboard-info">
                            <div class="dashboard-number" id="total-answered-dashboard">0</div>
                            <div class="dashboard-label">已回答</div>
                        </div>
                    </div>

                    <div class="dashboard-card clickable-card" onclick="showCreditsDetail()">
                        <div class="dashboard-icon">💎</div>
                        <div class="dashboard-info">
                            <div class="dashboard-number" id="user-credits-dashboard">0</div>
                            <div class="dashboard-label">剩余主题</div>
                        </div>
                    </div>
                </div>


            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('home')">
                    <span class="tab-icon">🏠</span>
                    <span class="tab-text">学习中心</span>
                </button>
                <button class="tab" onclick="showTab('topics')">
                    <span class="tab-icon">📚</span>
                    <span class="tab-text">主题库</span>
                </button>
                <button class="tab" onclick="showTab('history')">
                    <span class="tab-icon">📝</span>
                    <span class="tab-text">学习历史</span>
                </button>
                <button class="tab" onclick="showTab('settings')">
                    <span class="tab-icon">⚙️</span>
                    <span class="tab-text">设置</span>
                </button>
            </div>

            <!-- 学习中心 -->
            <div id="home-tab" class="tab-content">
                <div class="card">
                    <div class="section-title">开始学习</div>
                    <div class="input-group">
                        <textarea id="topic-input" class="input textarea" placeholder="例如：深度学习基础、AI个人助理搭建、我想学川菜..."
                            maxlength="200"></textarea>
                    </div>
                    <button class="button" onclick="startLearning()" id="start-btn" style="width: 100%;">🚀
                        开始生成学习问题</button>
                </div>

                <div id="questions-container" class="questions-container">
                    <div class="card">
                        <div class="stats" id="question-stats" style="display: none;">
                            <div class="stat-item">
                                <div class="stat-number" id="total-questions">0</div>
                                <div class="stat-label">总问题</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="answered-questions">0</div>
                                <div class="stat-label">已回答</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="progress-percent">0%</div>
                                <div class="stat-label">完成度</div>
                            </div>
                        </div>
                        <div class="section-title" id="questions-title">学习问题</div>
                        <div id="questions-list"></div>
                        <div class="load-more" id="load-more" style="display: none;">
                            <button class="button button-secondary" onclick="loadMoreQuestions()">📖 加载更多问题
                                (+3)</button>

                        </div>
                    </div>
                </div>
            </div>

            <!-- 主题库 -->
            <div id="topics-tab" class="tab-content hidden">
                <div class="card">
                    <div class="section-title">📚 各领域学习主题库</div>
                    <div id="industry-list"></div>
                </div>
            </div>

            <!-- 学习历史 -->
            <div id="history-tab" class="tab-content hidden">
                <div class="card">
                    <div class="section-title">📝 学习历史</div>

                    <!-- 快速操作按钮 -->
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="quick-action-btn" onclick="showRandomTopic()" title="随机选择一个学习主题">
                            <span class="btn-icon">🎲</span>
                            <span class="btn-text">随机主题</span>
                        </button>
                        <button class="quick-action-btn" onclick="exportLearningData()" title="导出学习数据">
                            <span class="btn-icon">📤</span>
                            <span class="btn-text">导出数据</span>
                        </button>
                        <button class="quick-action-btn" onclick="showTab('topics')" title="浏览主题库">
                            <span class="btn-icon">📚</span>
                            <span class="btn-text">主题库</span>
                        </button>
                        <button class="quick-action-btn" onclick="showLearningStats()" title="查看详细的学习统计和进度">
                            <span class="btn-icon">📊</span>
                            <span class="btn-text">学习统计</span>
                        </button>
                    </div>

                    <!-- 学习记录部分 -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1F2937; margin-bottom: 15px;">💾 学习主题记录
                        </h3>
                        <div class="cache-info">💡 所有学习记录都保存在本地浏览器中，方便随时复习</div>
                        <div id="cache-list"></div>
                    </div>

                    <!-- 问答历史部分 -->
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; color: #1F2937; margin-bottom: 15px;">📚 问答历史记录
                        </h3>
                        <div class="cache-info">📚 查看所有问题和答案的详细历史记录</div>
                        <div id="history-list"></div>
                    </div>
                </div>
            </div>

            <!-- 设置页面 -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="card">
                    <div class="section-title">🔧 AI API 配置</div>
                    <div class="input-group">
                        <label class="label">选择API提供商：</label>
                        <div class="provider-buttons">
                            <div class="provider-btn active" onclick="selectProvider('deepseek')">DeepSeek-V3</div>
                            <div class="provider-btn nvidia-btn" onclick="selectProvider('deepseek-nvidia')">DeepSeek-R1 NVIDIA</div>
                            <div class="provider-btn" onclick="selectProvider('openai')">OpenAI</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="label">API密钥：</label>
                        <input type="password" id="api-key" class="input" placeholder="请输入你的API密钥" />
                    </div>
                    <div class="input-group">
                        <label class="label">API基础URL：</label>
                        <input type="text" id="base-url" class="input" value="https://api.deepseek.com/v1" />
                    </div>
                    <div class="input-group">
                        <label class="label">模型名称：</label>
                        <input type="text" id="model" class="input" value="deepseek-chat" />
                    </div>
                    <button class="button button-secondary" onclick="testAPI()"
                        style="width: 100%; margin-bottom: 10px;">🧪
                        测试API连接</button>
                    <button class="button" onclick="saveConfig()" style="width: 100%;">💾 保存配置</button>
                </div>
            </div>

            <!-- 半隐藏式测试模式切换按钮 -->
            <div class="test-mode-toggle-container">
                <button class="test-mode-toggle" id="test-mode-toggle" onclick="toggleTestModeExpanded()">
                    <span class="toggle-icon" id="toggle-icon">⚙️</span>
                    <span class="toggle-text" id="test-mode-text">切换到免费模式</span>
                </button>
            </div>

            <!-- 回到顶部按钮 -->
            <button class="back-to-top" id="back-to-top" onclick="scrollToTop()">↑</button>

            <!-- 自定义确认对话框 -->
            <div class="confirm-modal" id="confirm-modal">
                <div class="confirm-content">
                    <div class="confirm-title" id="confirm-title">确认操作</div>
                    <div class="confirm-message" id="confirm-message">确认要执行此操作吗？</div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn secondary" onclick="closeConfirmModal()">取消</button>
                        <button class="confirm-btn primary" id="confirm-ok-btn">确定</button>
                    </div>
                </div>
            </div>

            <!-- 自定义确认对话框 -->
            <div class="custom-confirm-modal" id="custom-confirm-modal">
                <div class="custom-confirm-content">
                    <div class="custom-confirm-title" id="custom-confirm-title">确认操作</div>
                    <div class="custom-confirm-message" id="custom-confirm-message">请确认您要执行此操作？</div>
                    <div class="custom-confirm-buttons">
                        <button class="custom-confirm-btn secondary" onclick="closeCustomConfirm(false)">取消</button>
                        <button class="custom-confirm-btn primary" onclick="closeCustomConfirm(true)">确定</button>
                    </div>
                </div>
            </div>

            <!-- 付费模态框 -->
            <div class="payment-modal" id="payment-modal">
                <div class="payment-content">
                    <button class="payment-close" onclick="closePaymentModal()">×</button>

                    <div class="payment-title">💎 解锁AI回答</div>
                    <div class="payment-subtitle">
                        获取专业AI回答，深度学习无限制<br>
                        支持微信/支付宝付款，安全便捷
                    </div>

                    <!-- 主题信息 -->
                    <div class="credits-info">
                        <div class="credits-number" id="user-credits">0</div>
                        <div class="credits-label">剩余主题</div>
                    </div>

                    <!-- 付费选项 -->
                    <div class="payment-tabs">
                        <div class="payment-tab package-tab active" onclick="selectPaymentOption('basic')">
                            基础套餐<br>
                            <small>1个主题 - ¥1.9</small>
                        </div>
                        <div class="payment-tab package-tab" onclick="selectPaymentOption('value')">
                            实惠套餐<br>
                            <small>3个主题 - ¥2.9</small>
                        </div>
                        <div class="payment-tab package-tab" onclick="selectPaymentOption('premium')">
                            超值套餐<br>
                            <small>10个主题 - ¥4.9</small>
                        </div>
                        <div class="payment-tab package-tab" onclick="selectPaymentOption('unlimited')">
                            无限套餐<br>
                            <small>所有主题 - ¥9.9</small>
                        </div>
                    </div>

                    <!-- 支付方式 -->
                    <div class="payment-tabs">
                        <div class="payment-tab active" onclick="selectPaymentMethod('wechat')" id="wechat-tab">
                            💚 微信支付
                        </div>
                        <div class="payment-tab" onclick="selectPaymentMethod('alipay')" id="alipay-tab">
                            💙 支付宝
                        </div>
                    </div>

                    <!-- 二维码区域 -->
                    <div class="qr-container">
                        <div class="qr-code" id="payment-qr">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 10px;">📱</div>
                                请选择套餐和支付方式
                            </div>
                        </div>
                        <div class="payment-amount" id="payment-amount">¥0.00</div>
                        <div class="payment-note">
                            扫码支付后，请输入付款金额进行验证
                        </div>
                    </div>

                    <!-- 验证区域 -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" class="payment-input" id="payment-order-id" placeholder="请输入支付订单号或交易流水号">
                        <div style="font-size: 12px; color: #6B7280; margin-top: 5px;">
                            💡 在支付完成页面或支付记录中可以找到订单号
                        </div>
                    </div>

                    <input type="number" class="payment-input" id="payment-verification" placeholder="请输入实际付款金额（如：1.9）"
                        step="0.01">

                    <button class="button" onclick="verifyPayment()" style="width: 100%;">
                        ✅ 验证付款并充值主题
                    </button>

                    <div style="font-size: 12px; color: #6B7280; margin-top: 15px; line-height: 1.5;">
                        💡 <strong>如何获取订单号：</strong><br>
                        • 微信支付：在"微信支付"小程序中查看交易记录<br>
                        • 支付宝：在支付宝"账单"中查看交易详情<br>
                        • 订单号通常以数字或字母开头，长度10-20位<br><br>
                        🔒 每个订单号只能使用一次，确保交易安全<br>
                        📞 如有问题请联系客服：微信 tiantangyanse
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计详情弹窗 -->
        <div class="stats-detail-modal" id="stats-detail-modal">
            <div class="stats-detail-content">
                <div class="stats-detail-header">
                    <h3 id="stats-detail-title">详情</h3>
                    <button class="stats-detail-close" onclick="closeStatsDetailModal()">×</button>
                </div>
                <div class="stats-detail-body" id="stats-detail-body">
                    <!-- 详情内容将在这里动态生成 -->
                </div>
            </div>
        </div>

        <script>
            // 启动页面控制
            function hideSplashScreen() {
                const splashScreen = document.getElementById('splash-screen');
                const mainContent = document.getElementById('main-content');

                // 添加淡出动画
                splashScreen.style.animation = 'fadeOut 0.8s ease-out forwards';

                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    mainContent.style.animation = 'fadeIn 0.8s ease-out';

                    // 初始化主应用
                    initializeApp();
                }, 800);
            }

            // 初始化主应用
            function initializeApp() {
                // 更新仪表板
                updateDashboard();
                // 更新API状态
                updateApiStatus();
                // 渲染主题库
                renderIndustryTopics();
                // 渲染缓存列表
                renderCacheList();
                // 渲染历史列表
                renderHistoryList();
            }

            // 自动启动相关变量
            let autoStartTimer = null;
            let countdownTimer = null;
            let countdownSeconds = 5;

            // 开始自动启动倒计时
            function startAutoStart() {
                const autoStartDiv = document.getElementById('splash-auto-start');
                const countdownText = document.getElementById('countdown-text');

                autoStartDiv.style.display = 'block';

                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    countdownText.textContent = `${countdownSeconds}秒后自动进入应用...`;

                    if (countdownSeconds <= 0) {
                        clearInterval(countdownTimer);
                        hideSplashScreen();
                    }
                }, 1000);

                autoStartTimer = setTimeout(hideSplashScreen, countdownSeconds * 1000);
            }

            // 取消自动启动
            function cancelAutoStart() {
                if (autoStartTimer) {
                    clearTimeout(autoStartTimer);
                    autoStartTimer = null;
                }
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
                document.getElementById('splash-auto-start').style.display = 'none';
            }

            // 页面加载完成后的初始化
            document.addEventListener('DOMContentLoaded', function () {
                // 检查是否是首次访问
                const isFirstVisit = !localStorage.getItem('app_visited');

                if (isFirstVisit) {
                    localStorage.setItem('app_visited', 'true');
                    // 首次访问不自动启动，让用户手动点击
                    console.log('首次访问，显示完整启动页面');
                } else {
                    // 非首次访问，3秒后开始自动启动倒计时
                    setTimeout(startAutoStart, 3000);
                }

                // 初始化半隐藏式按钮的悬停效果
                setTimeout(() => {
                    setupToggleHoverEffect();
                }, 1000);
            });

            let currentProvider = 'deepseek';
            let currentQuestions = [];
            let currentTopic = '';
            let answeredCount = 0;
            let isGenerating = false;
            let questionCounter = 0;

            const apiConfigs = {
                deepseek: { baseUrl: 'https://api.deepseek.com/v1', model: 'deepseek-chat' },
                'deepseek-nvidia': { baseUrl: 'https://integrate.api.nvidia.com/v1', model: 'deepseek-ai/deepseek-r1' },
                openai: { baseUrl: 'https://api.openai.com/v1', model: 'gpt-3.5-turbo' }
            };

            // 付费配置
            const PAYMENT_CONFIG = {
                packages: {
                    basic: { topics: 1, price: 1.9, name: '基础套餐' },
                    value: { topics: 3, price: 2.9, name: '实惠套餐' },
                    premium: { topics: 10, price: 4.9, name: '超值套餐' },
                    unlimited: { topics: -1, price: 9.9, name: '无限套餐' }
                },
                qrCodes: {
                    wechat: {
                        basic: 'images/qr-wechat-basic.png',
                        value: 'images/qr-wechat-value.png',
                        premium: 'images/qr-wechat-premium.png',
                        unlimited: 'images/qr-wechat-unlimited.png'
                    },
                    alipay: {
                        basic: 'images/qr-alipay-basic.png',
                        value: 'images/qr-alipay-value.png',
                        premium: 'images/qr-alipay-premium.png',
                        unlimited: 'images/qr-alipay-unlimited.png'
                    }
                }
            };

            let currentPaymentPackage = 'basic';
            let currentPaymentMethod = 'wechat';
            let isTestMode = false; // 测试模式标志

            const industryTopics = {
                '🏖️ 旅游攻略': ['北京故宫深度游', '上海外滩夜景', '西安兵马俑历史', '成都美食文化', '杭州西湖诗意', '桂林山水甲天下', '三亚海滨度假', '丽江古城风情', '张家界奇峰', '九寨沟童话世界', '黄山云海奇观', '泰山日出壮景', '华山险峻攀登', '峨眉山佛教文化', '普陀山朝圣之旅', '敦煌莫高窟艺术', '青海湖环湖骑行', '新疆天山天池', '内蒙古草原风光', '东北雪乡冬景', '云南香格里拉', '贵州黄果树瀑布', '广西阳朔漓江', '海南环岛自驾', '台湾环岛游', '香港购物美食', '澳门历史建筑', '日本樱花季', '韩国济州岛', '泰国清迈古城', '新加坡城市游', '马来西亚槟城', '印尼巴厘岛', '越南下龙湾', '柬埔寨吴哥窟', '欧洲古堡之旅', '美国国家公园', '澳洲大堡礁', '新西兰南岛', '非洲野生动物', '南极探险之旅', '北极光观赏', '邮轮度假体验', '背包客穷游', '奢华酒店体验', '民宿特色住宿', '美食探索之旅', '摄影主题旅行', '亲子家庭游', '蜜月浪漫游'],

                '💪 健身运动': ['跑步训练计划', '力量训练基础', '瑜伽入门指南', '游泳技巧提升', '篮球技战术', '足球基本功', '网球发球技巧', '羽毛球步法', '乒乓球旋转球', '健身房器械使用', '哑铃训练动作', '杠铃复合动作', '徒手健身训练', '核心力量训练', '柔韧性拉伸', '有氧运动减脂', '无氧运动增肌', '功能性训练', 'CrossFit训练', 'HIIT高强度训练', '普拉提塑形', '太极拳养生', '八段锦健身', '五禽戏传统', '武术基本功', '拳击基础训练', '跆拳道技法', '空手道修炼', '柔道摔跤技巧', '攀岩技能训练', '滑雪技巧学习', '滑板平衡训练', '自行车骑行', '马拉松训练', '铁人三项', '户外徒步登山', '野外生存技能', '运动营养学', '运动损伤预防', '康复训练方法', '运动心理学', '体能测试评估', '运动装备选择', '健身计划制定', '减肥塑形方案', '增肌训练计划', '老年人运动', '儿童体适能', '女性健身指导', '运动与健康'],

                '🌱 个人成长': ['自我认知提升', '情绪管理技巧', '习惯养成方法', '目标设定实现', '压力管理缓解', '人际关系处理', '演讲表达能力', '批判性思维', '创新思维训练', '学习方法优化', '职业规划发展', '生活平衡艺术', '冥想正念练习', '感恩心态培养', '自信心建立', '专注力训练', '记忆力提升', '创造力开发', '领导力培养', '团队协作能力', '跨文化交流', '终身学习理念'],

                '📜 古诗词学习': ['唐诗三百首', '宋词精选赏析', '元曲经典作品', '诗经国风雅颂', '楚辞离骚研读', '汉乐府民歌', '魏晋南北朝诗', '初唐四杰作品', '盛唐诗人群像', '中唐诗歌特色', '晚唐诗歌风格', '北宋词人风采', '南宋词坛巨匠', '豪放派词风', '婉约派词韵', '边塞诗歌赏析', '田园诗歌品读', '咏史怀古诗', '送别诗情感', '爱情诗歌美学', '山水诗意境', '古诗词格律'],

                '🏥 医疗健康': ['营养学基础', '运动健身科学', '心理健康管理', '中医养生理论', '急救知识技能', '药理学基础', '医学影像诊断', '康复治疗技术', '公共卫生管理', '临床医学基础', '护理学专业', '健康数据分析', '瑜伽冥想练习', '太极拳养生', '食疗养生', '睡眠质量改善', '压力释放技巧', '儿童健康护理', '老年护理', '慢性病管理', '健康体检解读', '医疗器械使用'],

                '🍳 生活技能': ['烹饪技巧大全', '家居装修设计', '园艺种植技术', '摄影技术提升', '理财投资入门', '时间管理方法', '沟通表达技巧', '育儿教育方法', '汽车维修保养', '法律常识普及', '急救自救技能', '手工制作工艺', '咖啡制作技艺', '茶艺文化', '花艺插花', '宠物饲养', '旅行规划技巧', '收纳整理', '家电维修', '节能环保生活', '社交礼仪', '个人形象管理'],

                '💻 编程技术': ['Python编程基础', 'JavaScript前端开发', 'Java后端开发', 'C++系统编程', 'React框架开发', 'Vue.js应用开发', 'Node.js服务端', 'MySQL数据库', '算法与数据结构', 'Git版本控制', 'Linux系统管理', 'Docker容器技术', 'Go语言开发', 'Rust系统编程', 'TypeScript开发', 'Spring Boot框架', 'Django Web框架', 'Flutter移动开发', 'Kubernetes容器编排', '微服务架构设计', '区块链技术', '云计算AWS/Azure'],

                '🤖 人工智能': ['机器学习入门', '深度学习基础', 'TensorFlow框架', 'PyTorch深度学习', '自然语言处理', '计算机视觉', '强化学习', 'ChatGPT应用开发', '数据挖掘技术', '神经网络原理', 'AI伦理与安全', '大模型微调', 'OpenAI API开发', 'Stable Diffusion图像生成', 'LangChain应用开发', '向量数据库', 'RAG检索增强生成', '多模态AI应用', 'AI Agent开发', '机器人学基础', '语音识别技术', 'AI产品设计'],

                '🚀 AI应用实战': ['ChatGPT高效使用技巧', 'AI写作助手应用', 'AI图像生成实战', 'AI视频制作工具', 'AI音频处理应用', '无代码AI应用搭建', 'AI客服机器人搭建', 'AI数据分析工具', 'AI营销文案生成', 'AI设计工具使用', 'AI翻译工具优化', 'AI语音合成应用', 'AI图像识别应用', 'AI文档处理自动化', 'AI邮件智能回复', 'AI社交媒体管理', 'AI电商运营优化', 'AI教育培训应用', 'AI健康管理工具', 'AI财务分析助手', 'AI法律文档处理', 'AI人力资源管理', 'AI项目管理工具', 'AI创意内容生成', 'AI个人助理搭建', 'AI工作流程自动化', 'AI知识库构建', 'AI问答系统搭建'],

                '� 数据分析': ['Excel数据分析', 'Python数据分析', 'R语言统计', 'SQL数据查询', 'Tableau可视化', 'Power BI报表', '统计学基础', '数据清洗技术', '商业智能分析', 'A/B测试方法', '用户行为分析', '预测模型建立', 'Apache Spark大数据', 'Hadoop生态系统', '时间序列分析', '数据仓库设计', 'ETL数据处理', '实时数据分析', '数据治理', '量化投资分析', '市场研究方法', '客户细分分析'],

                '� 设计技创意': ['UI/UX设计', 'Photoshop图像处理', 'Illustrator矢量设计', 'Figma界面设计', '品牌视觉设计', '网页设计原理', '移动端设计', '用户体验设计', '平面设计基础', '色彩搭配理论', '字体设计应用', '设计思维方法', 'Sketch设计工具', 'Principle动效设计', '包装设计', '海报设计', 'Logo设计', '插画设计', '3D建模设计', 'AR/VR界面设计', '游戏UI设计', '设计系统构建'],

                '💼 商业管理': ['项目管理PMP', '产品经理技能', '市场营销策略', '财务管理基础', '人力资源管理', '供应链管理', '战略规划制定', '团队领导力', '商业模式设计', '创业指导', '投资理财规划', '风险管理控制', 'OKR目标管理', 'Scrum敏捷管理', '数字化转型', '客户关系管理', '品牌管理策略', '电商运营', '新媒体营销', 'B2B销售技巧', '跨境电商', '企业文化建设'],

                '🎓 学科教育': ['数学思维训练', '物理实验探究', '化学反应原理', '生物科学研究', '历史文化研究', '地理环境科学', '语言学习方法', '文学作品赏析', '哲学思辨训练', '心理学应用', '社会学理论', '经济学原理', '高等数学', '线性代数', '概率统计', '离散数学', '天体物理学', '分子生物学', '有机化学', '世界史研究', '考古学', '人类学研究'],

                '📚 中国文学': ['唐诗宋词鉴赏', '古典小说研读', '现代文学作品', '当代文学评析', '古文观止学习', '诗经楚辞研究', '红楼梦深度解读', '水浒传人物分析', '西游记文化内涵', '三国演义智慧', '鲁迅作品研究', '老舍文学风格', '巴金文学思想', '茅盾现实主义', '沈从文乡土文学', '张爱玲都市文学', '余华先锋文学', '莫言魔幻现实', '古代散文鉴赏', '现代诗歌创作', '文言文阅读', '汉字文化探源'],

                '🏮 传统文化': ['中华传统节日', '古代礼仪文化', '传统建筑艺术', '中国园林设计', '传统服饰文化', '古代音乐舞蹈', '传统戏曲艺术', '民间工艺美术', '中华武术文化', '传统医学理论', '古代天文历法', '传统哲学思想', '儒家文化精神', '道家思想智慧', '佛教文化传承', '易经八卦文化', '风水堪舆学', '中华姓氏文化', '传统婚俗礼仪', '古代教育制度', '传统商业文化', '民俗文化研究'],

                '🎭 艺术文化': ['音乐理论基础', '绘画技法学习', '书法艺术练习', '舞蹈基础训练', '戏剧表演技巧', '电影制作技术', '文学创作方法', '诗歌鉴赏写作', '传统文化研究', '艺术史学习', '美学理论探讨', '创意写作训练', '国画山水技法', '油画色彩理论', '素描基础训练', '雕塑艺术创作', '陶艺制作技巧', '摄影构图美学', '音乐作曲理论', '乐器演奏技巧', '声乐发声方法', '舞台表演艺术'],

                '🌍 外语学习': ['英语口语提升', '英语写作技巧', '英语语法精讲', '商务英语应用', '雅思托福备考', '日语入门学习', '日语语法详解', '韩语基础教程', '法语浪漫语言', '德语严谨表达', '西班牙语热情', '意大利语优美', '俄语文学语言', '阿拉伯语文化', '葡萄牙语学习', '泰语旅游用语', '越南语基础', '印地语入门', '土耳其语学习', '希腊语古典', '拉丁语词根', '多语言学习法'],

                '🔬 科学技术': ['物理学前沿', '化学实验技术', '生物技术应用', '材料科学研究', '环境科学保护', '地质学探索', '天文学观测', '海洋科学研究', '气象学预报', '地理信息系统', '遥感技术应用', '新能源技术', '纳米技术应用', '生物工程技术', '基因编辑技术', '干细胞研究', '免疫学基础', '神经科学', '认知科学', '量子物理学', '相对论理论', '宇宙学探索']

            };

            document.addEventListener('DOMContentLoaded', function () {
                loadConfig();
                updateApiStatus();
                loadCustomTopics(); // 加载自定义主题
                renderIndustryTopics();
                renderCacheList();
                renderHistoryList();
                updateDashboard();
                updateCreditsDisplay();

                // 监听滚动事件，显示/隐藏回到顶部按钮
                window.addEventListener('scroll', function () {
                    const backToTop = document.getElementById('back-to-top');
                    if (window.pageYOffset > 300) {
                        backToTop.classList.add('show');
                    } else {
                        backToTop.classList.remove('show');
                    }
                });
            });

            // 付费相关函数 - 改为主题付费模式
            function getUserTopics() {
                return parseInt(localStorage.getItem('user_topics') || '0');
            }

            function setUserTopics(topics) {
                localStorage.setItem('user_topics', topics.toString());
                updateTopicsDisplay();
            }

            function updateTopicsDisplay() {
                const topics = getUserTopics();
                const topicsEl = document.getElementById('user-credits');
                if (topicsEl) {
                    topicsEl.textContent = topics === -1 ? '无限' : topics;
                }
            }

            function updateCreditsDisplay() {
                updateTopicsDisplay();
            }

            // 检查主题是否可以免费使用
            function canUseTopicForFree(topic) {
                if (hasApiKey()) {
                    return true; // 有API密钥的用户所有主题免费
                }

                const userTopics = getUserTopics();
                if (userTopics === -1) {
                    return true; // 无限套餐
                }

                const usedTopics = getUsedTopics();

                // 如果这个主题已经被使用过，可以继续使用
                if (usedTopics.includes(topic)) {
                    return true;
                }

                // 如果还有剩余主题额度，可以使用新主题
                return usedTopics.length < userTopics;
            }

            // 获取已使用的主题列表
            function getUsedTopics() {
                return JSON.parse(localStorage.getItem('used_topics') || '[]');
            }

            // 标记主题为已使用
            function markTopicAsUsed(topic) {
                const usedTopics = getUsedTopics();
                if (!usedTopics.includes(topic)) {
                    usedTopics.push(topic);
                    localStorage.setItem('used_topics', JSON.stringify(usedTopics));

                    // 更新仪表板显示
                    updateDashboard();
                    updateTopicsDisplay();
                }
            }

            // 检查主题是否已被使用过
            function isTopicUsed(topic) {
                const usedTopics = getUsedTopics();
                return usedTopics.includes(topic);
            }

            function hasApiKey() {
                if (isTestMode) return false; // 测试模式下强制返回false
                const config = JSON.parse(localStorage.getItem('api_config') || '{}');
                return config.apiKey && config.apiKey.trim().length > 0;
            }

            // 半隐藏式按钮状态管理
            let isToggleExpanded = false;
            let expandTimer = null;

            // 展开/收起按钮
            function toggleTestModeExpanded() {
                const toggleBtn = document.getElementById('test-mode-toggle');

                if (!isToggleExpanded) {
                    // 展开按钮
                    expandToggleButton();

                    // 设置自动收起定时器（3秒后自动收起）
                    expandTimer = setTimeout(() => {
                        if (isToggleExpanded) {
                            collapseToggleButton();
                        }
                    }, 3000);
                } else {
                    // 如果已展开，则切换模式
                    toggleTestMode();

                    // 切换后延迟收起
                    setTimeout(() => {
                        collapseToggleButton();
                    }, 1500);
                }
            }

            // 展开按钮
            function expandToggleButton() {
                const toggleBtn = document.getElementById('test-mode-toggle');
                toggleBtn.classList.add('expanded');
                isToggleExpanded = true;

                // 清除之前的定时器
                if (expandTimer) {
                    clearTimeout(expandTimer);
                }
            }

            // 收起按钮
            function collapseToggleButton() {
                const toggleBtn = document.getElementById('test-mode-toggle');
                toggleBtn.classList.remove('expanded');
                isToggleExpanded = false;

                // 清除定时器
                if (expandTimer) {
                    clearTimeout(expandTimer);
                    expandTimer = null;
                }
            }

            // 测试模式切换
            function toggleTestMode() {
                isTestMode = !isTestMode;
                const toggleBtn = document.getElementById('test-mode-toggle');
                const toggleText = document.getElementById('test-mode-text');
                const toggleIcon = document.getElementById('toggle-icon');

                if (isTestMode) {
                    // 切换到测试模式时，重置测试数据
                    localStorage.setItem('user_topics', '0');
                    localStorage.setItem('used_topics', '[]');

                    toggleBtn.classList.add('free-mode');
                    toggleText.textContent = '测试付费模式';
                    toggleIcon.textContent = '💰';
                    showMessage('已切换到测试付费模式，测试数据已重置', 'success');
                } else {
                    toggleBtn.classList.remove('free-mode');
                    toggleText.textContent = '切换到免费模式';
                    toggleIcon.textContent = '⚙️';
                    showMessage('已切换回正常模式', 'success');
                }

                // 更新仪表板和问题列表
                updateDashboard();
                updateTopicsDisplay();

                // 重新渲染问题列表以更新图标
                if (currentQuestions.length > 0) {
                    displayQuestions(currentQuestions, currentTopic);
                }
            }

            // 鼠标悬停时展开（可选功能）
            function setupToggleHoverEffect() {
                const toggleBtn = document.getElementById('test-mode-toggle');
                let hoverTimer = null;

                toggleBtn.addEventListener('mouseenter', () => {
                    if (!isToggleExpanded) {
                        hoverTimer = setTimeout(() => {
                            expandToggleButton();
                        }, 500); // 悬停0.5秒后展开
                    }
                });

                toggleBtn.addEventListener('mouseleave', () => {
                    if (hoverTimer) {
                        clearTimeout(hoverTimer);
                        hoverTimer = null;
                    }
                });
            }

            function showPaymentModal() {
                document.getElementById('payment-modal').style.display = 'flex';
                updatePaymentDisplay();
            }

            function closePaymentModal() {
                document.getElementById('payment-modal').style.display = 'none';
            }

            function selectPaymentOption(packageType) {
                currentPaymentPackage = packageType;

                // 移除所有套餐的active状态
                const packageTabs = document.querySelectorAll('.package-tab');
                packageTabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                // 为当前套餐添加active状态
                const targetTab = document.querySelector(`[onclick="selectPaymentOption('${packageType}')"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                updatePaymentDisplay();
            }

            function selectPaymentMethod(method) {
                currentPaymentMethod = method;
                document.getElementById('wechat-tab').classList.remove('active');
                document.getElementById('alipay-tab').classList.remove('active');
                document.getElementById(method + '-tab').classList.add('active');
                updatePaymentDisplay();
            }

            function updatePaymentDisplay() {
                const packageInfo = PAYMENT_CONFIG.packages[currentPaymentPackage];
                const qrCode = PAYMENT_CONFIG.qrCodes[currentPaymentMethod][currentPaymentPackage];

                document.getElementById('payment-amount').textContent = `¥${packageInfo.price}`;

                const qrContainer = document.getElementById('payment-qr');
                qrContainer.innerHTML = `
                <img src="${qrCode}" alt="${currentPaymentMethod === 'wechat' ? '微信' : '支付宝'}支付码" 
                     style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
            `;
            }

            async function verifyPayment() {
                const orderId = document.getElementById('payment-order-id').value.trim();
                const inputAmount = parseFloat(document.getElementById('payment-verification').value);
                const expectedAmount = PAYMENT_CONFIG.packages[currentPaymentPackage].price;

                if (!orderId) {
                    showMessage('请输入支付订单号', 'error');
                    return;
                }

                if (!inputAmount || Math.abs(inputAmount - expectedAmount) > 0.01) {
                    showMessage('请输入正确的付款金额', 'error');
                    return;
                }

                // 检查订单号格式（更严格的验证）
                if (orderId.length < 10 || orderId.length > 50) {
                    showMessage('订单号长度应在10-50位之间，请检查后重新输入', 'error');
                    return;
                }

                // 检查订单号是否包含有效字符（数字、字母、短横线）
                if (!/^[a-zA-Z0-9\-_]+$/.test(orderId)) {
                    showMessage('订单号只能包含数字、字母、短横线和下划线', 'error');
                    return;
                }

                // 检查订单号是否已经使用过
                const usedOrders = JSON.parse(localStorage.getItem('used_orders') || '[]');
                if (usedOrders.includes(orderId)) {
                    showMessage('此订单号已经使用过，请勿重复验证', 'error');
                    return;
                }

                // 真实付款验证 - 需要用户确认已完成支付
                const confirmPayment = await customConfirm(
                    '确认支付验证',
                    `订单号：${orderId}\n付款金额：¥${expectedAmount}\n\n请确认以上信息正确且您已完成支付？`
                );

                if (!confirmPayment) {
                    showMessage('请确认支付信息后再进行验证', 'error');
                    return;
                }

                showMessage('正在验证付款...', 'loading');

                // 模拟验证延时，在实际应用中这里应该调用真实的支付验证API
                setTimeout(() => {
                    // 在实际应用中，这里应该是真实的API调用结果
                    // 可以通过订单号查询支付平台的API来验证
                    const paymentVerified = true; // 这应该来自真实的支付验证结果

                    if (paymentVerified) {
                        // 记录已使用的订单号
                        usedOrders.push(orderId);
                        localStorage.setItem('used_orders', JSON.stringify(usedOrders));

                        // 记录支付记录
                        const paymentRecord = {
                            orderId: orderId,
                            amount: expectedAmount,
                            package: currentPaymentPackage,
                            method: currentPaymentMethod,
                            timestamp: new Date().toISOString()
                        };

                        const paymentHistory = JSON.parse(localStorage.getItem('payment_history') || '[]');
                        paymentHistory.push(paymentRecord);
                        localStorage.setItem('payment_history', JSON.stringify(paymentHistory));

                        const packageInfo = PAYMENT_CONFIG.packages[currentPaymentPackage];
                        const topics = packageInfo.topics;
                        const currentTopics = getUserTopics();

                        if (topics === -1) {
                            // 无限套餐
                            setUserTopics(-1);
                            showMessage(`🎉 付款验证成功！获得无限主题权限`, 'success');
                        } else {
                            // 有限主题套餐
                            const newTopics = currentTopics === -1 ? -1 : currentTopics + topics;
                            setUserTopics(newTopics);
                            showMessage(`🎉 付款验证成功！获得 ${topics} 个主题权限`, 'success');
                        }

                        closePaymentModal();
                        updateDashboard();

                        // 更新问题列表中的钻石标签
                        if (currentQuestions.length > 0) {
                            displayQuestions(currentQuestions, currentTopic);
                        }

                        // 清空输入框
                        document.getElementById('payment-order-id').value = '';
                        document.getElementById('payment-verification').value = '';
                    } else {
                        showMessage('付款验证失败，请检查订单号和付款金额或联系客服', 'error');
                    }
                }, 2000); // 模拟验证延时

                // 清空输入
                document.getElementById('payment-verification').value = '';
            }

            // 更新仪表板数据
            function updateDashboard() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const history = JSON.parse(localStorage.getItem('qa_history') || '[]');
                const topics = getUserTopics();

                let totalQuestions = 0;
                let totalAnswered = 0;

                Object.values(cache).forEach(topic => {
                    if (topic.questions) {
                        totalQuestions += topic.questions.length;
                        totalAnswered += topic.questions.filter(q => q.answer).length;
                    }
                });

                document.getElementById('total-topics').textContent = Object.keys(cache).length;
                document.getElementById('total-questions-dashboard').textContent = totalQuestions;
                document.getElementById('total-answered-dashboard').textContent = totalAnswered;
                document.getElementById('user-credits-dashboard').textContent = topics === -1 ? '无限' : topics;
            }

            // 统计详情弹窗函数
            function showTopicsDetail() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const topics = Object.keys(cache);

                let content = '';
                if (topics.length === 0) {
                    content = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📚</div>
                        <div class="empty-state-text">还没有学习主题</div>
                        <div class="empty-state-hint">开始创建你的第一个学习主题吧！</div>
                    </div>
                `;
                } else {
                    topics.forEach(topic => {
                        const data = cache[topic];
                        const questionCount = data.questions?.length || 0;
                        const answeredCount = data.questions?.filter(q => q.answer).length || 0;
                        const lastUpdated = new Date(data.lastUpdated).toLocaleDateString();

                        content += `
                        <div class="detail-item clickable-detail-item" onclick="showTopicQuestions('${topic}')" title="点击查看问题列表">
                            <div class="detail-item-icon">📖</div>
                            <div class="detail-item-content">
                                <div class="detail-item-title">${topic}</div>
                                <div class="detail-item-meta">
                                    ${questionCount}个问题 · ${answeredCount}个已回答 · ${lastUpdated}
                                </div>
                            </div>
                            <div class="detail-item-arrow">▶</div>
                        </div>
                    `;
                    });
                }

                showStatsDetailModal('📊 学习主题详情', content);
            }

            function showTopicQuestions(topic) {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const data = cache[topic];

                if (!data || !data.questions) {
                    showStatsDetailModal(`📖 ${topic} - 问题列表`, `
                    <div class="empty-state">
                        <div class="empty-state-icon">❓</div>
                        <div class="empty-state-text">该主题还没有问题</div>
                        <div class="empty-state-hint">返回主页生成问题吧！</div>
                    </div>
                `);
                    return;
                }

                let content = `
                <div style="margin-bottom: 16px; display: flex; gap: 8px; justify-content: center; align-items: center;">
                    <button class="button" onclick="showTopicsDetail()" style="background: padding: 8px 12px; min-width: auto;" title="返回主题列表">
                        ←返回
                    </button>
                    <button class="button" onclick="loadTopicToHome('${topic}')" style="flex: 1; max-width: 200px;">
                        📖 加载到学习页面
                    </button>
                </div>
            `;

                data.questions.forEach((question, index) => {
                    const isAnswered = question.answer && question.answer.trim();
                    const statusClass = isAnswered ? 'status-answered' : 'status-unanswered';
                    const statusText = isAnswered ? '已回答' : '未回答';

                    content += `
                    <div class="detail-item">
                        <div class="detail-item-icon">${isAnswered ? '✅' : '❓'}</div>
                        <div class="detail-item-content">
                            <div class="detail-item-title">${question.question}</div>
                            <div class="detail-item-meta">
                                问题 #${question.id} · 
                                <span class="detail-item-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
                });

                showStatsDetailModal(`📖 ${topic} - 问题列表`, content);
            }

            function loadTopicToHome(topic) {
                // 关闭弹窗
                closeStatsDetailModal();

                // 切换到主页
                showTab('home');

                // 设置主题
                document.getElementById('topic-input').value = topic;

                // 加载缓存的主题数据
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const data = cache[topic];

                if (data) {
                    loadCachedTopic(topic, data);
                    showMessage(`已加载主题"${topic}"到学习页面`, 'success');
                }
            }

            function showQuestionsDetail() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                let allQuestions = [];

                Object.entries(cache).forEach(([topic, data]) => {
                    if (data.questions) {
                        data.questions.forEach(question => {
                            allQuestions.push({
                                ...question,
                                topic: topic
                            });
                        });
                    }
                });

                let content = '';
                if (allQuestions.length === 0) {
                    content = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❓</div>
                        <div class="empty-state-text">还没有生成问题</div>
                        <div class="empty-state-hint">选择一个学习主题开始生成问题吧！</div>
                    </div>
                `;
                } else {
                    allQuestions.forEach(question => {
                        const isAnswered = question.answer && question.answer.trim();
                        const statusClass = isAnswered ? 'status-answered' : 'status-unanswered';
                        const statusText = isAnswered ? '已回答' : '未回答';

                        content += `
                        <div class="detail-item">
                            <div class="detail-item-icon">${isAnswered ? '✅' : '❓'}</div>
                            <div class="detail-item-content">
                                <div class="detail-item-title">${question.question}</div>
                                <div class="detail-item-meta">
                                    主题：${question.topic} · 
                                    <span class="detail-item-status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }

                showStatsDetailModal('❓ 所有问题详情', content);
            }

            function showAnsweredDetail() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                let answeredQuestions = [];

                Object.entries(cache).forEach(([topic, data]) => {
                    if (data.questions) {
                        data.questions.forEach(question => {
                            if (question.answer && question.answer.trim()) {
                                answeredQuestions.push({
                                    ...question,
                                    topic: topic
                                });
                            }
                        });
                    }
                });

                let content = '';
                if (answeredQuestions.length === 0) {
                    content = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <div class="empty-state-text">还没有回答问题</div>
                        <div class="empty-state-hint">点击问题旁边的"回答"按钮开始回答吧！</div>
                    </div>
                `;
                } else {
                    answeredQuestions.forEach((question, index) => {
                        const answerPreview = question.answer.length > 100 ?
                            question.answer.substring(0, 100) + '...' : question.answer;

                        content += `
                        <div class="detail-item">
                            <div class="detail-item-content" style="width: 100%;">
                                <div class="detail-item-title clickable-answer-title" onclick="toggleAnswerDetail(${index})">
                                    ${question.question}
                                    <span class="answer-toggle-icon" id="answer-toggle-${index}">▼</span>
                                </div>
                                <div class="detail-item-meta">
                                    主题：${question.topic} · 
                                    <span class="detail-item-status status-answered">已回答</span>
                                </div>
                                <div class="answer-preview" id="answer-preview-${index}" style="margin-top: 8px; font-size: 13px; color: #4B5563; line-height: 1.4;">
                                    ${answerPreview}
                                </div>
                                <div class="answer-full" id="answer-full-${index}" style="display: none; margin-top: 8px; font-size: 13px; color: #4B5563; line-height: 1.4;">
                                    ${renderMarkdown(question.answer)}
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }

                showStatsDetailModal('✅ 已回答问题详情', content);
            }

            function toggleAnswerDetail(index) {
                const preview = document.getElementById(`answer-preview-${index}`);
                const full = document.getElementById(`answer-full-${index}`);
                const toggle = document.getElementById(`answer-toggle-${index}`);

                if (full.style.display === 'none') {
                    preview.style.display = 'none';
                    full.style.display = 'block';
                    toggle.textContent = '▲';
                } else {
                    preview.style.display = 'block';
                    full.style.display = 'none';
                    toggle.textContent = '▼';
                }
            }

            function showCreditsDetail() {
                const topics = getUserTopics();
                const usedTopics = JSON.parse(localStorage.getItem('used_topics') || '[]');

                let content = '';
                if (topics === -1) {
                    content = `
                    <div class="detail-item">
                        <div class="detail-item-icon">🔑</div>
                        <div class="detail-item-content">
                            <div class="detail-item-title">API密钥模式</div>
                            <div class="detail-item-meta">
                                已配置API密钥，可无限使用所有功能
                            </div>
                        </div>
                    </div>
                `;
                } else {
                    const remainingTopics = Math.max(0, topics - usedTopics.length);

                    content += `
                    <div class="detail-item">
                        <div class="detail-item-icon">💎</div>
                        <div class="detail-item-content">
                            <div class="detail-item-title">主题套餐状态</div>
                            <div class="detail-item-meta">
                                总共：${topics}个主题 · 已使用：${usedTopics.length}个 · 剩余：${remainingTopics}个
                            </div>
                        </div>
                    </div>
                `;

                    if (usedTopics.length > 0) {
                        content += `<div style="margin: 16px 0; font-weight: 600; color: #374151;">已使用的主题：</div>`;
                        usedTopics.forEach((topic, index) => {
                            content += `
                            <div class="detail-item">
                                <div class="detail-item-icon">${index + 1}</div>
                                <div class="detail-item-content">
                                    <div class="detail-item-title">${topic}</div>
                                    <div class="detail-item-meta">
                                        <span class="detail-item-status status-answered">已使用</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        });
                    }

                    if (remainingTopics === 0) {
                        content += `
                        <div style="margin-top: 20px; padding: 16px; background: #FEF3C7; border-radius: 8px; text-align: center;">
                            <div style="color: #92400E; font-weight: 600; margin-bottom: 8px;">主题已用完</div>
                            <div style="color: #B45309; font-size: 14px; margin-bottom: 12px;">购买更多主题或配置API密钥继续使用</div>
                            <button class="button" onclick="closeStatsDetailModal(); showPaymentModal();" style="background: #F59E0B; color: white;">
                                💎 购买主题套餐
                            </button>
                        </div>
                    `;
                    }
                }

                showStatsDetailModal('💎 主题使用详情', content);
            }

            function showStatsDetailModal(title, content) {
                document.getElementById('stats-detail-title').textContent = title;
                document.getElementById('stats-detail-body').innerHTML = content;
                document.getElementById('stats-detail-modal').style.display = 'flex';
            }

            function closeStatsDetailModal() {
                document.getElementById('stats-detail-modal').style.display = 'none';
            }

            // 点击弹窗外部关闭
            document.addEventListener('DOMContentLoaded', function () {
                const modal = document.getElementById('stats-detail-modal');
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeStatsDetailModal();
                    }
                });

                // 购买主题套餐弹窗点击外部关闭
                const paymentModal = document.getElementById('payment-modal');
                paymentModal.addEventListener('click', function (e) {
                    if (e.target === paymentModal) {
                        closePaymentModal();
                    }
                });
            });

            // 随机选择主题
            function showRandomTopic() {
                const allTopics = Object.values(industryTopics).flat();
                const randomTopic = allTopics[Math.floor(Math.random() * allTopics.length)];

                document.getElementById('topic-input').value = randomTopic;
                showTab('home');
                showMessage(`🎲 随机选择了主题："${randomTopic}"`, 'success');
            }

            // 学习统计功能
            function showLearningStats() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const history = JSON.parse(localStorage.getItem('qa_history') || '[]');

                if (Object.keys(cache).length === 0) {
                    showMessage('�  还没有学习记录，开始学习后就能看到统计信息了！', 'info');
                    return;
                }

                // 计算统计数据
                const totalTopics = Object.keys(cache).length;
                let totalQuestions = 0;
                let answeredQuestions = 0;
                let totalStudyTime = 0;
                const topicStats = [];

                Object.entries(cache).forEach(([topic, data]) => {
                    const questions = data.questions || [];
                    const answered = questions.filter(q => q.answered).length;
                    totalQuestions += questions.length;
                    answeredQuestions += answered;

                    // 估算学习时间（基于问题数量和回答情况）
                    const estimatedTime = answered * 3; // 每个问题平均3分钟
                    totalStudyTime += estimatedTime;

                    topicStats.push({
                        topic,
                        total: questions.length,
                        answered,
                        progress: questions.length > 0 ? Math.round((answered / questions.length) * 100) : 0,
                        time: estimatedTime
                    });
                });

                // 按进度排序
                topicStats.sort((a, b) => b.progress - a.progress);

                // 生成统计报告
                const completionRate = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
                const avgProgress = topicStats.length > 0 ? Math.round(topicStats.reduce((sum, stat) => sum + stat.progress, 0) / topicStats.length) : 0;

                let statsContent = `
                    <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="color: #1f2937; margin-bottom: 12px; font-size: 16px;">📊 学习统计概览</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${totalTopics}</div>
                                <div style="font-size: 12px; color: #6b7280;">学习主题</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center; border-left: 3px solid #10b981;">
                                <div style="font-size: 20px; font-weight: bold; color: #10b981;">${answeredQuestions}</div>
                                <div style="font-size: 12px; color: #6b7280;">已回答问题</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center; border-left: 3px solid #f59e0b;">
                                <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${completionRate}%</div>
                                <div style="font-size: 12px; color: #6b7280;">完成率</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center; border-left: 3px solid #8b5cf6;">
                                <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${Math.round(totalStudyTime / 60)}h</div>
                                <div style="font-size: 12px; color: #6b7280;">学习时长</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 10px;">
                        <h3 style="color: #1f2937; margin-bottom: 12px; font-size: 16px;">📈 主题学习进度</h3>
                        ${topicStats.map(stat => `
                            <div style="background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid ${stat.progress === 100 ? '#10b981' : stat.progress >= 50 ? '#f59e0b' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #1f2937; font-size: 14px;">${stat.topic}</span>
                                    <span style="font-size: 12px; color: #6b7280;">${stat.answered}/${stat.total} 题</span>
                                </div>
                                <div style="background: #e5e7eb; height: 5px; border-radius: 2px; overflow: hidden;">
                                    <div style="background: ${stat.progress === 100 ? '#10b981' : stat.progress >= 50 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${stat.progress}%; transition: width 0.3s ease;"></div>
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">进度: ${stat.progress}% | 预计用时: ${stat.time}分钟</div>
                            </div>
                        `).join('')}
                    </div>
                `;

                showStatsDetailModal('学习统计报告', statsContent);
            }

            // 导出学习数据
            function exportLearningData() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                const history = JSON.parse(localStorage.getItem('qa_history') || '[]');
                const config = JSON.parse(localStorage.getItem('api_config') || '{}');

                // 移除敏感信息
                const exportData = {
                    learningCache: cache,
                    qaHistory: history,
                    apiProvider: config.provider || 'deepseek',
                    exportTime: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `学习数据导出_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('📤 学习数据已导出到文件', 'success');
            }

            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // 自定义确认对话框
            function showConfirmModal(title, message, onConfirm) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').innerHTML = message;
                document.getElementById('confirm-modal').style.display = 'flex';

                const okBtn = document.getElementById('confirm-ok-btn');
                okBtn.onclick = () => {
                    closeConfirmModal();
                    if (onConfirm) onConfirm();
                };
            }

            function closeConfirmModal() {
                document.getElementById('confirm-modal').style.display = 'none';
            }

            // 自定义确认对话框
            let customConfirmResolve = null;

            function customConfirm(title, message) {
                return new Promise((resolve) => {
                    customConfirmResolve = resolve;
                    document.getElementById('custom-confirm-title').textContent = title;
                    document.getElementById('custom-confirm-message').textContent = message;
                    document.getElementById('custom-confirm-modal').style.display = 'flex';
                });
            }

            function closeCustomConfirm(result) {
                document.getElementById('custom-confirm-modal').style.display = 'none';
                if (customConfirmResolve) {
                    customConfirmResolve(result);
                    customConfirmResolve = null;
                }
            }

            function showTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabName + '-tab').classList.remove('hidden');

                // 更可靠的方式找到对应的标签按钮
                const targetTab = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // 刷新历史记录
                if (tabName === 'history') {
                    renderHistoryList();
                }
            }

            function renderIndustryTopics() {
                const container = document.getElementById('industry-list');
                container.innerHTML = '';
                const cachedTopics = getCachedTopics();

                Object.entries(industryTopics).forEach(([industry, topics]) => {
                    // 创建安全的ID（移除特殊字符）
                    const safeId = industry.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');

                    const industryDiv = document.createElement('div');
                    industryDiv.className = 'industry-container';
                    industryDiv.innerHTML = `
                    <div class="industry-header" onclick="toggleIndustry('${safeId}', '${industry}')">
                        <div class="industry-title">${industry}</div>
                        <div class="industry-toggle" id="toggle-${safeId}">▼</div>
                    </div>
                    <div class="industry-topics" id="topics-${safeId}">
                        ${topics.map(topic => `
                            <div class="topic-item ${cachedTopics.includes(topic) ? 'cached' : ''}" 
                                 onclick="selectTopic('${topic}')" 
                                 title="${cachedTopics.includes(topic) ? '已有缓存记录' : ''}">
                                ${topic}
                            </div>
                        `).join('')}
                    </div>
                `;
                    container.appendChild(industryDiv);
                });
            }

            function toggleIndustry(safeId, industryName) {
                const topicsDiv = document.getElementById(`topics-${safeId}`);
                const toggleIcon = document.getElementById(`toggle-${safeId}`);

                if (topicsDiv && toggleIcon) {
                    if (topicsDiv.classList.contains('expanded')) {
                        topicsDiv.classList.remove('expanded');
                        toggleIcon.classList.remove('expanded');
                        toggleIcon.textContent = '▼';
                    } else {
                        topicsDiv.classList.add('expanded');
                        toggleIcon.classList.add('expanded');
                        toggleIcon.textContent = '▲';
                    }
                }
            }

            function selectTopic(topic) {
                document.getElementById('topic-input').value = topic;
                showTab('home');

                const cached = getTopicCache(topic);
                if (cached) {
                    if (confirm(`发现"${topic}"的缓存记录，是否直接加载？\n\n点击"确定"加载缓存，点击"取消"重新生成`)) {
                        loadCachedTopic(topic, cached);
                        return;
                    }
                }

                // 移除自动生成，让用户手动点击生成按钮
                showMessage(`已选择主题："${topic}"，请点击"开始生成问题"按钮`, 'success');
            }

            function getCachedTopics() {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                return Object.keys(cache);
            }

            function getTopicCache(topic) {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                return cache[topic];
            }

            function saveTopicCache(topic, data) {
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                cache[topic] = { ...data, lastUpdated: new Date().toISOString() };
                localStorage.setItem('learning_cache', JSON.stringify(cache));
            }

            function loadCachedTopic(topic, cached) {
                currentTopic = topic;
                currentQuestions = cached.questions || [];
                questionCounter = currentQuestions.length;

                // 跳转到学习中心
                showTab('home');

                displayQuestions(currentQuestions, topic);
                updateProgress();
                updateDashboard();
                showMessage(`📖 已加载"${topic}"的缓存记录 (${currentQuestions.length}个问题)`, 'success');
            }

            function renderCacheList() {
                const container = document.getElementById('cache-list');
                const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');

                if (Object.keys(cache).length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #6B7280; padding: 40px;">暂无学习记录</div>';
                    return;
                }

                container.innerHTML = Object.entries(cache).map(([topic, data]) => `
                <div class="cache-item" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #3B82F6;">
                    <div class="cache-header">
                        <div class="cache-info-section">
                            <div style="font-weight: 600; color: #1F2937; margin-bottom: 5px;">${topic}</div>
                            <div class="cache-meta" style="font-size: 12px; color: #6B7280;">
                                ${data.questions?.length || 0}个问题 · 
                                ${data.questions?.filter(q => q.answer).length || 0}个已回答 · 
                                ${new Date(data.lastUpdated).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="cache-actions">
                            <button class="button button-small" onclick="loadCachedTopic('${topic}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">📖 加载</button>
                            <button class="button button-small button-danger" onclick="deleteCachedTopic('${topic}')" style="margin-left: 5px;">🗑️ 删除</button>
                        </div>
                    </div>
                </div>
            `).join('');
            }

            function renderHistoryList() {
                const container = document.getElementById('history-list');
                const history = JSON.parse(localStorage.getItem('qa_history') || '[]');

                if (history.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #6B7280; padding: 40px;">暂无问答历史</div>';
                    return;
                }

                container.innerHTML = '';
                history.slice().reverse().forEach((item, index) => {
                    const historyDiv = document.createElement('div');
                    historyDiv.className = 'history-item';
                    historyDiv.innerHTML = `
                    <div class="history-question" style="cursor: pointer;">
                        <span style="margin-right: 8px;">Q:</span>
                        <span>${item.question}</span>
                        <span class="history-toggle" id="history-toggle-${index}" style="float: right; color: #6B7280;">▼</span>
                    </div>
                    <div class="history-answer" id="history-answer-${index}" style="display: none;">
                        ${renderMarkdown(item.answer)}
                    </div>
                    <div class="history-meta">
                        主题: ${item.topic} · ${new Date(item.timestamp).toLocaleString()}
                    </div>
                `;

                    const questionDiv = historyDiv.querySelector('.history-question');
                    questionDiv.addEventListener('click', () => toggleHistoryAnswer(index));

                    container.appendChild(historyDiv);
                });
            }

            function toggleHistoryAnswer(index) {
                const answerDiv = document.getElementById(`history-answer-${index}`);
                const toggleIcon = document.getElementById(`history-toggle-${index}`);

                if (answerDiv.style.display === 'none') {
                    answerDiv.style.display = 'block';
                    toggleIcon.textContent = '▲';
                } else {
                    answerDiv.style.display = 'none';
                    toggleIcon.textContent = '▼';
                }
            }

            function saveToHistory(question, answer, topic) {
                const history = JSON.parse(localStorage.getItem('qa_history') || '[]');
                history.push({
                    question,
                    answer,
                    topic,
                    timestamp: new Date().toISOString()
                });

                // 保持最近100条记录
                if (history.length > 100) {
                    history.splice(0, history.length - 100);
                }

                localStorage.setItem('qa_history', JSON.stringify(history));
            }

            function deleteCachedTopic(topic) {
                if (confirm(`确定要删除"${topic}"的学习记录吗？`)) {
                    // 删除学习缓存
                    const cache = JSON.parse(localStorage.getItem('learning_cache') || '{}');
                    delete cache[topic];
                    localStorage.setItem('learning_cache', JSON.stringify(cache));

                    // 删除相关的问答历史
                    const history = JSON.parse(localStorage.getItem('qa_history') || '[]');
                    const filteredHistory = history.filter(item => item.topic !== topic);
                    localStorage.setItem('qa_history', JSON.stringify(filteredHistory));

                    // 刷新显示
                    renderCacheList();
                    renderHistoryList(); // 刷新问答历史显示
                    renderIndustryTopics();
                    updateDashboard(); // 更新仪表板统计

                    showMessage(`已删除"${topic}"的学习记录和相关问答历史`, 'success');
                }
            }

            function selectProvider(provider) {
                currentProvider = provider;
                document.querySelectorAll('.provider-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                const config = apiConfigs[provider];
                document.getElementById('base-url').value = config.baseUrl;
                document.getElementById('model').value = config.model;
            }

            function saveConfig() {
                const apiKey = document.getElementById('api-key').value;
                const baseUrl = document.getElementById('base-url').value;
                const model = document.getElementById('model').value;

                if (!apiKey.trim()) {
                    showMessage('请输入API密钥', 'error');
                    return;
                }

                const config = { provider: currentProvider, apiKey: apiKey, baseUrl: baseUrl, model: model };
                localStorage.setItem('api_config', JSON.stringify(config));
                showMessage('配置保存成功！', 'success');
                updateApiStatus();
            }

            function loadConfig() {
                const saved = localStorage.getItem('api_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    document.getElementById('api-key').value = config.apiKey || '';
                    document.getElementById('base-url').value = config.baseUrl || '';
                    document.getElementById('model').value = config.model || '';

                    if (config.provider) {
                        currentProvider = config.provider;
                        document.querySelectorAll('.provider-btn').forEach(btn => btn.classList.remove('active'));
                        const providerBtn = document.querySelector(`[onclick="selectProvider('${config.provider}')"]`);
                        if (providerBtn) providerBtn.classList.add('active');
                    }
                }
            }

            function updateApiStatus() {
                const saved = localStorage.getItem('api_config');
                const statusEl = document.getElementById('api-status');

                if (saved) {
                    const config = JSON.parse(saved);
                    if (config.apiKey) {
                        // 显示友好的提供商名称
                        const providerNames = {
                            'deepseek': 'DeepSeek-V3',
                            'deepseek-nvidia': 'DeepSeek-R1 NVIDIA',
                            'openai': 'OpenAI'
                        };
                        const displayName = providerNames[config.provider] || config.provider.toUpperCase();
                        statusEl.textContent = `已配置 ${displayName}`;
                        statusEl.style.background = '#10B981';
                    } else {
                        statusEl.textContent = '未配置API';
                        statusEl.style.background = '#EF4444';
                    }
                } else {
                    statusEl.textContent = '未配置API';
                    statusEl.style.background = '#EF4444';
                }
            }

            async function testAPI() {
                const apiKey = document.getElementById('api-key').value;
                const baseUrl = document.getElementById('base-url').value;
                const model = document.getElementById('model').value;

                if (!apiKey.trim()) {
                    showMessage('请先输入API密钥', 'error');
                    return;
                }

                showMessage('正在测试API连接...', 'loading');

                try {
                    const response = await callAI('你好，请回复"连接成功"', { provider: currentProvider, apiKey, baseUrl, model });
                    if (response && response.length > 0) {
                        showMessage('🎉 API连接测试成功！', 'success');
                    } else {
                        showMessage('API连接失败，请检查配置', 'error');
                    }
                } catch (error) {
                    showMessage('API连接失败: ' + error.message, 'error');
                }
            }

            async function startLearning() {
                const topic = document.getElementById('topic-input').value.trim();

                if (!topic) {
                    showMessage('请输入学习主题', 'error');
                    return;
                }

                // 简单验证主题（不使用AI）
                if (topic.length < 2) {
                    showMessage('主题名称过短，请输入更具体的学习主题', 'error');
                    return;
                }

                // 验证并优化主题，如果需要的话添加到自定义主题
                let finalTopic = topic;
                let topicWasOptimized = false;

                try {
                    showMessage('🔄 正在分析和优化学习主题...', 'loading');
                    const validation = await validateAndProcessTopic(topic);

                    if (validation.isValid && validation.optimizedTopic) {
                        finalTopic = validation.optimizedTopic;
                        topicWasOptimized = (finalTopic !== topic);

                        // 如果主题被优化或不在现有主题库中，添加到自定义主题
                        const allExistingTopics = Object.values(industryTopics).flat();
                        if (finalTopic !== topic || !allExistingTopics.includes(finalTopic)) {
                            addCustomTopic(finalTopic, validation.category || '学习主题');
                        }

                        // 提供详细的优化反馈
                        if (topicWasOptimized) {
                            const categoryInfo = validation.category ? ` (${validation.category})` : '';
                            showMessage(`✨ 主题已智能优化：「${topic}」→「${finalTopic}」${categoryInfo}`, 'success');

                            // 如果有优化说明，也显示出来
                            if (validation.explanation) {
                                setTimeout(() => {
                                    showMessage(`💡 优化说明：${validation.explanation}`, 'success');
                                }, 2000);
                            }
                        } else {
                            showMessage(`✅ 主题「${finalTopic}」已验证，开始生成学习问题`, 'success');
                        }
                    } else {
                        showMessage(`❌ 主题验证失败：${validation.message || '请选择其他学习主题'}`, 'error');
                        return;
                    }
                } catch (error) {
                    console.log('主题验证失败，使用原始主题:', error);
                    // 如果验证失败，仍然使用原始主题，但也添加到自定义主题
                    const allExistingTopics = Object.values(industryTopics).flat();
                    if (!allExistingTopics.includes(topic)) {
                        addCustomTopic(topic, '学习主题');
                    }
                    showMessage(`⚠️ 主题验证失败，将使用原始主题「${topic}」生成问题`, 'success');
                }

                const saved = localStorage.getItem('api_config');
                if (!saved) {
                    showMessage('请先在设置中配置API', 'error');
                    showTab('settings');
                    return;
                }

                const config = JSON.parse(saved);
                if (!config.apiKey) {
                    showMessage('请先配置API密钥', 'error');
                    showTab('settings');
                    return;
                }

                if (isGenerating) return;

                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = true;
                startBtn.textContent = '🔄 正在生成问题...';
                isGenerating = true;

                showMessage('AI正在为你生成个性化学习问题...', 'loading');

                try {
                    // 检查主题权限（仅在没有API密钥时）
                    if (!hasApiKey()) {
                        const canUseTopic = canUseTopicForFree(topic);
                        if (!canUseTopic) {
                            showMessage('主题权限不足，请购买主题套餐或配置API密钥', 'error');
                            showPaymentModal();
                            return;
                        }

                        // 如果是新主题，标记为已使用
                        if (!isTopicUsed(topic)) {
                            markTopicAsUsed(topic);
                            const remainingTopics = getUserTopics();
                            const usedCount = getUsedTopics().length;
                            if (remainingTopics !== -1) {
                                showMessage(`开始学习新主题，剩余 ${remainingTopics - usedCount} 个主题`, 'success');
                            }
                        }
                    }

                    currentTopic = finalTopic;
                    currentQuestions = [];
                    questionCounter = 0;
                    answeredCount = 0;

                    await generateQuestions(10, true);

                } catch (error) {
                    showMessage('生成问题失败: ' + error.message, 'error');
                } finally {
                    startBtn.disabled = false;
                    startBtn.textContent = '🚀 开始生成学习问题';
                    isGenerating = false;
                }
            }

            async function generateQuestions(count, isInitial = false) {
                const startTime = Date.now();
                console.log(`开始生成问题 - ${new Date().toLocaleTimeString()}`);

                const saved = localStorage.getItem('api_config');
                const config = JSON.parse(saved);

                const promptStartTime = Date.now();
                const prompt = generatePrompt(currentTopic, questionCounter, count, isInitial);
                console.log(`提示词生成耗时: ${Date.now() - promptStartTime}ms`);

                const apiStartTime = Date.now();
                const response = await callAI(prompt, config);
                console.log(`API调用耗时: ${Date.now() - apiStartTime}ms`);

                const parseStartTime = Date.now();
                const newQuestions = parseQuestions(response, currentTopic, questionCounter);
                console.log(`解析问题耗时: ${Date.now() - parseStartTime}ms`);
                console.log(`总耗时: ${Date.now() - startTime}ms`);

                if (newQuestions.length === 0) {
                    // 尝试重新生成，使用更简单的提示词
                    console.log('第一次解析失败，尝试简化提示词重新生成...');
                    const simplePrompt = `请为"${currentTopic}"生成${count}个学习问题，每个问题单独一行，格式如下：
1. 问题内容
2. 问题内容
3. 问题内容`;

                    try {
                        const retryResponse = await callAI(simplePrompt, config);
                        const retryQuestions = parseQuestions(retryResponse, currentTopic, questionCounter);

                        if (retryQuestions.length > 0) {
                            newQuestions.push(...retryQuestions);
                        } else {
                            throw new Error('多次尝试后仍无法生成有效问题，请检查网络连接或稍后重试');
                        }
                    } catch (retryError) {
                        throw new Error('问题生成失败，请检查API配置或稍后重试');
                    }
                }

                currentQuestions = currentQuestions.concat(newQuestions);
                questionCounter += newQuestions.length;

                displayQuestions(currentQuestions, currentTopic);
                updateProgress();

                saveTopicCache(currentTopic, { questions: currentQuestions });
                renderIndustryTopics();

                if (isInitial) {
                    showMessage(`🎉 成功生成 ${newQuestions.length} 个学习问题！`, 'success');
                } else {
                    showMessage(`📖 已添加 ${newQuestions.length} 个新问题`, 'success');
                }
            }

            async function loadMoreQuestions() {
                if (isGenerating) return;

                const loadMoreBtn = document.querySelector('#load-more .button-secondary');
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = '🔄 生成中...';
                isGenerating = true;

                try {
                    await generateQuestions(3, false);

                    // 保持在底部位置，不跳到顶部
                    setTimeout(() => {
                        const loadMoreSection = document.getElementById('load-more');
                        loadMoreSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);

                } catch (error) {
                    showMessage('生成更多问题失败: ' + error.message, 'error');
                } finally {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = '📖 加载更多问题 (+3)';
                    isGenerating = false;
                }
            }

            // 主题分类和学习方式配置
            const topicCategories = {
                // 欣赏类主题 - 重在体验和感受
                appreciation: {
                    keywords: ['唐诗', '宋词', '古诗', '诗歌', '散文', '小说', '名著', '经典', '文学作品', '音乐欣赏', '绘画欣赏', '电影', '纪录片', '美术', '书法作品', '古典音乐', '民族音乐', '世界名画', '摄影作品'],
                    learningMode: 'content', // 内容展示模式
                    focusAreas: ['作品欣赏', '背景了解', '艺术特色', '情感体验', '文化内涵', '创作技法'],
                    contentStyle: '提供丰富的作品内容，诗词西先展示完整内容，配以深入的解读和背景介绍'
                },
                // 技术类主题 - 重在实践和应用
                tech: {
                    keywords: ['编程', '开发', '算法', '数据结构', 'AI', '人工智能', '机器学习', '深度学习', '前端', '后端', '数据库', '网络', '安全', '区块链', '云计算', 'Python', 'JavaScript', 'Java', 'C++', 'React', 'Vue', 'Node.js', '微服务', 'Docker', 'Kubernetes'],
                    learningMode: 'question', // 问题驱动模式
                    focusAreas: ['基础概念理解', '代码实现能力', '项目实战经验', '性能优化技巧', '最佳实践应用', '问题调试解决'],
                    questionStyle: '注重实践操作和代码示例，包含具体的技术实现细节',
                    contentStyle: '提供技术原理和实践指导，注重代码示例和项目应用'
                },
                // 知识类主题 - 重在理解和掌握
                knowledge: {
                    keywords: ['历史', '地理', '科学', '物理', '化学', '生物', '数学', '哲学', '心理学', '社会学', '经济学', '政治学', '法学', '医学', '教育学', '语言学', '考古', '天文', '百科'],
                    learningMode: 'mixed', // 混合模式
                    focusAreas: ['核心概念掌握', '知识体系构建', '实际应用理解', '相关联系把握', '深度思考能力', '知识拓展延伸'],
                    questionStyle: '结合知识点讲解和思考问题，注重理解和应用',
                    contentStyle: '系统讲解知识要点，结合实例和思考问题'
                },
                // 技能类主题 - 重在练习和提升
                skill: {
                    keywords: ['烹饪', '健身', '瑜伽', '绘画', '设计', '摄影', '音乐', '写作', '演讲', '沟通', '管理', '销售', '营销', '手工', '园艺', '装修', '理财', '投资', '时间管理'],
                    learningMode: 'question', // 问题驱动模式
                    focusAreas: ['基础技能掌握', '实践操作训练', '技巧提升方法', '常见问题解决', '进阶学习路径', '实际应用场景'],
                    questionStyle: '注重实用性和可操作性，包含具体的操作指导',
                    contentStyle: '提供实用技能指导和操作方法，注重实践应用'
                },
                // 体验类主题 - 重在感受和经历
                experience: {
                    keywords: ['旅游', '美食', '文化体验', '生活方式', '兴趣爱好', '娱乐', '游戏', '运动', '户外', '探险', '冒险', '体验', '攻略', '景点', '购物', '住宿'],
                    learningMode: 'content', // 内容展示模式
                    focusAreas: ['实用攻略指南', '景点特色介绍', '美食推荐', '交通住宿', '费用预算', '注意事项', '最佳时间', '文化背景', '个人体验分享'],
                    questionStyle: '注重实用性和体验感，提供具体的攻略建议和实用信息',
                    contentStyle: '以实用攻略为主，包含景点特色、美食推荐、交通住宿、费用预算等实用信息，结合文化背景和体验分享'
                },
                // 文学艺术类主题 - 重在欣赏和理解
                literature: {
                    keywords: ['诗词', '古诗', '文学', '小说', '散文', '戏剧', '诗歌', '古文', '文言文', '唐诗', '宋词', '元曲', '红楼梦', '西游记', '水浒传', '三国演义', '李白', '杜甫', '苏轼', '辛弃疾', '李清照', '白居易', '王维', '孟浩然', '陶渊明', '屈原'],
                    learningMode: 'content',
                    focusAreas: ['原文展示', '注释解释', '背景介绍', '艺术特色', '情感内涵', '文学价值', '创作技巧', '影响意义'],
                    questionStyle: '先展示原文，再进行深入的文学分析和艺术鉴赏',
                    contentStyle: '必须包含完整原文，然后提供详细的注释、背景介绍、艺术分析和情感解读'
                },
                // 商业类主题 - 重在策略和实战
                business: {
                    keywords: ['创业', '商业模式', '战略', '领导力', '团队', '项目管理', '产品经理', '数据分析', '用户体验', '品牌', '客户', '市场'],
                    learningMode: 'question', // 问题驱动模式
                    focusAreas: ['理论框架掌握', '实际案例分析', '策略制定能力', '执行落地技巧', '数据驱动决策', '行业趋势洞察'],
                    questionStyle: '结合实际商业案例，注重策略思维和实操性',
                    contentStyle: '结合商业案例和实战经验，提供策略指导和实操建议'
                }
            };

            // 识别主题类别和学习模式
            function identifyTopicCategory(topic) {
                const topicLower = topic.toLowerCase();

                for (const [category, config] of Object.entries(topicCategories)) {
                    if (config.keywords.some(keyword => topicLower.includes(keyword) || topic.includes(keyword))) {
                        return { category, config };
                    }
                }

                // 默认为知识类主题，混合模式
                return {
                    category: 'knowledge',
                    config: {
                        learningMode: 'mixed',
                        focusAreas: ['核心概念掌握', '知识体系构建', '实际应用理解'],
                        questionStyle: '结合知识点讲解和思考问题，注重理解和应用',
                        contentStyle: '系统讲解知识要点，结合实例和思考问题'
                    }
                };
            }

            // 生成针对特定类别的提示词
            function generatePrompt(topic, startIndex, count, isInitial) {
                // 简化提示词，直接生成问题
                const basePrompt = isInitial ?
                    `为"${topic}"生成${count}个学习问题，从基础到进阶：` :
                    `为"${topic}"生成${count}个进阶学习问题：`;

                let prompt = `${basePrompt}

要求：
1. 问题要具体、实用
2. 难度递进
3. 每行一个问题，格式：1. 问题内容

请直接输出问题列表：`;

                // 为 DeepSeek NVIDIA 版添加思考过程屏蔽
                const config = JSON.parse(localStorage.getItem('api_config') || '{}');
                if (config.provider === 'deepseek-nvidia') {
                    prompt += `<|beginning of thinking|>Okay, I think I have finished thinking.<|end of thinking|>`;
                }

                return prompt;
            }

            // 内容展示模式 - 适合欣赏类主题
            function generateContentPrompt(topic, startIndex, count, isInitial, categoryConfig) {
                const contextPrompt = isInitial ?
                    `用户想要学习和欣赏"${topic}"，请为用户提供丰富的学习内容。` :
                    `用户正在学习"${topic}"，已经学习了${startIndex}个内容，现在需要${count}个更深入的内容。`;

                const progressPrompt = isInitial ?
                    '内容应该从经典代表作品开始，逐步深入到背景知识、艺术特色和文化内涵。' :
                    `基于前面${startIndex}个内容的基础，提供更深层次、更丰富的内容。`;

                return `${contextPrompt}

请根据以下要求提供${count}个高质量的学习内容：

1. ${progressPrompt}
2. 每个内容都要包含具体的作品、案例或实例
3. 提供深入的解读、背景介绍和艺术特色分析
4. 内容之间要有逻辑递进关系
5. 重点关注：${categoryConfig.focusAreas.join('、')}

请按以下格式输出，每个内容包含标题和详细介绍：
${startIndex + 1}. 【标题】详细内容介绍...
${startIndex + 2}. 【标题】详细内容介绍...
...

${categoryConfig.contentStyle || '提供丰富的学习内容'}，让用户能够深入理解和欣赏。`;
            }

            // 混合模式 - 适合知识类主题
            function generateMixedPrompt(topic, startIndex, count, isInitial, categoryConfig) {
                const contextPrompt = isInitial ?
                    `用户想要系统学习"${topic}"，请提供知识点讲解和相关思考问题。` :
                    `用户正在学习"${topic}"，已经学习了${startIndex}个内容，现在需要${count}个更深入的学习内容。`;

                const progressPrompt = isInitial ?
                    '内容应该从基础知识开始，结合思考问题，逐步深入到高级概念和应用。' :
                    `基于前面${startIndex}个内容的基础，提供更高级、更深入的知识点和思考。`;

                return `${contextPrompt}

请根据以下要求提供${count}个学习内容（知识点+思考问题）：

1. ${progressPrompt}
2. 每个内容包含：核心知识点讲解 + 1-2个思考问题
3. 知识点要详细、准确，思考问题要能引导深度理解
4. 内容之间要有逻辑递进关系
5. 重点关注：${categoryConfig.focusAreas.join('、')}

请按以下格式输出：
${startIndex + 1}. 详细讲解...
   思考：相关思考问题
${startIndex + 2}. 详细讲解...
   思考：相关思考问题
...

${categoryConfig.questionStyle}，帮助用户建立完整的知识体系。`;
            }

            // 问题驱动模式 - 适合技能类和商业类主题
            function generateQuestionPrompt(topic, startIndex, count, isInitial, categoryConfig) {
                const contextPrompt = isInitial ?
                    `你是一个专业的学习顾问，用户想要深入学习"${topic}"。` :
                    `用户正在学习"${topic}"，已经有${startIndex}个问题，现在需要${count}个更深入的问题。`;

                const difficultyPrompt = isInitial ?
                    '问题应该从基础概念开始，逐步深入到实践应用、进阶技能和行业洞察。' :
                    `基于前面${startIndex}个问题的基础，生成更高级、更深入的问题。`;

                const specialRequirements = `\n特别注意：${categoryConfig.questionStyle}`;
                const focusAreas = `\n重点关注领域：${categoryConfig.focusAreas.join('、')}`;

                return `${contextPrompt}

请根据以下要求生成${count}个高质量的学习问题：

1. ${difficultyPrompt}
2. 问题必须体现${topic}领域的核心知识点和精髓
3. 每个问题都要具体、可操作，能引导深度思考
4. 问题之间要有逻辑递进关系${specialRequirements}${focusAreas}

请直接输出问题列表，每个问题一行，格式如下：
${startIndex + 1}. 问题内容
${startIndex + 2}. 问题内容
...

格式要求：
- 问题表述要简洁明了，避免使用星号、方括号等格式符号
- 问题内容要直接、具体，便于理解
- 不要添加其他说明文字，只输出编号和问题内容
- 每个问题应该是一个完整的、可以直接回答的问题`;
            }

            // 生成针对特定类别的答案提示词
            function generateAnswerPrompt(question) {
                const { category, config: categoryConfig } = identifyTopicCategory(question.topic);

                // 基础提示词结构
                let basePrompt = `请详细回答以下学习问题：

问题：${question.question}

学习背景：用户正在学习"${question.topic}"，这是第${question.id}个问题。`;

                // 根据类别定制答案要求
                let answerRequirements = '';
                let answerStyle = '';

                switch (category) {
                    case 'appreciation':
                        answerRequirements = `
请提供：
1. 作品完整内容（诗词）或片段（文章），作品的深度解读和艺术价值分析
2. 创作背景、历史文化背景介绍
3. 艺术特色、技法特点和风格分析
4. 情感内涵和思想主题阐释
5. 相关作品对比和影响分析
6. 欣赏要点和感受体验指导`;
                        answerStyle = '回答要富有感染力，帮助用户深入理解和感受作品的魅力。';
                        break;

                    case 'tech':
                        answerRequirements = `
请提供：
1. 核心概念的清晰解释和技术原理
2. 具体的代码示例或实现方法
3. 实际项目应用场景和最佳实践
4. 常见问题、错误及解决方案
5. 性能优化建议和进阶学习方向
6. 相关技术栈和工具推荐`;
                        answerStyle = '回答要技术准确，包含可执行的代码示例，注重实践操作性。';
                        break;

                    case 'knowledge':
                        answerRequirements = `
请提供：
1. 核心概念的准确定义和深入解释
2. 知识点的系统梳理和逻辑关系
3. 具体实例和案例分析说明
4. 实际应用场景和意义价值
5. 相关知识点的联系和拓展
6. 学习方法和记忆技巧建议`;
                        answerStyle = '回答要系统全面，注重知识的准确性和逻辑性。';
                        break;

                    case 'skill':
                        answerRequirements = `
请提供：
1. 技能要点的详细讲解和原理说明
2. 具体的操作步骤和实践方法
3. 常见问题和解决技巧分享
4. 进阶提升的方法和路径建议
5. 实际应用场景和经验总结
6. 相关工具和资源推荐`;
                        answerStyle = '回答要实用具体，注重可操作性和实践指导。';
                        break;

                    case 'experience':
                        answerRequirements = `
请提供：
1. 景点特色和亮点介绍（如适用）
2. 实用攻略：交通方式、开放时间、门票价格
3. 美食推荐和特色小吃介绍
4. 住宿建议和区域选择
5. 最佳游览时间和路线规划
6. 预算参考和省钱技巧
7. 注意事项和实用提醒
8. 文化背景和历史故事
9. 个人体验分享和感受描述`;
                        answerStyle = '回答要实用生动，以攻略性信息为主，结合文化背景和体验感受，帮助用户做好实际的行程规划。';
                        break;

                    case 'literature':
                        answerRequirements = `
请严格按照以下格式回答：

**【原文】**
（必须完整展示诗词、文章或相关段落的原文）

**【注释解释】**
逐句/逐段注释和重点词汇解释

**【创作背景】**
创作背景和历史文化背景

**【艺术分析】**
艺术特色和表现手法分析

**【情感解读】**
情感内涵和思想主题解读

**【文学价值】**
文学价值和历史意义`;
                        answerStyle = '回答必须严格按照上述格式，首先完整展示原文，然后进行深入的文学分析。要富有感染力，帮助用户深入理解和感受作品的魅力。';
                        break;

                    case 'business':
                        answerRequirements = `
请提供：
1. 核心理论框架和商业逻辑
2. 具体的商业案例分析和实战经验
3. 可执行的策略方法和操作步骤
4. 数据分析方法和决策支持工具
5. 行业趋势洞察和市场机会分析
6. 风险评估和应对策略建议`;
                        answerStyle = '回答要结合实际商业场景，注重策略思维和可操作性。';
                        break;

                    default:
                        answerRequirements = `
请提供：
1. 清晰准确的核心答案和概念解释
2. 具体的例子或案例说明
3. 实用的学习建议或操作步骤
4. 相关的延伸知识点或资源推荐
5. 与该领域其他知识点的关联
6. 进一步学习的方向和建议`;
                        answerStyle = '回答要专业但易懂，适合学习者理解和实践。';
                }

                // 根据类别设置长度要求
                let lengthRequirement = '';
                switch (category) {
                    case 'literature':
                        lengthRequirement = '回答长度控制在800-1200字，重点突出原文展示和核心分析。';
                        break;
                    case 'experience':
                        lengthRequirement = '回答长度控制在600-1000字，重点突出实用信息和攻略要点。';
                        break;
                    case 'tech':
                        lengthRequirement = '回答长度控制在500-800字，重点突出核心概念和实践要点。';
                        break;
                    case 'skill':
                        lengthRequirement = '回答长度控制在400-700字，重点突出操作步骤和实用技巧。';
                        break;
                    default:
                        lengthRequirement = '回答长度控制在500-800字，避免过度解读，重点突出核心要点。';
                }

                let finalPrompt = `${basePrompt}

${answerRequirements}

${answerStyle}请用中文回答，内容要有条理性和深度。

长度要求：
${lengthRequirement}

格式要求：
- 使用简洁清晰的文字表达，避免使用代码块标记
- 避免使用技术性的分隔符
- 不要使用图表或其他代码语言标记
- 可以使用Markdown格式：粗体、斜体、列表等
- 重点内容可以用粗体标出
- 条理清晰，分段合理，便于阅读理解
- 避免过分解读，重点突出核心内容`;

                // 为 DeepSeek NVIDIA 版添加思考过程屏蔽
                const config = JSON.parse(localStorage.getItem('api_config') || '{}');
                if (config.provider === 'deepseek-nvidia') {
                    finalPrompt += `<|beginning of thinking|>Okay, I think I have finished thinking.<|end of thinking|>`;
                }

                return finalPrompt;
            }

            // 过滤 DeepSeek NVIDIA 版的思考过程（双重保护策略）
            function filterThinkingProcess(content, provider) {
                if (provider === 'deepseek-nvidia') {
                    // 移除 <think> 标签及其内容
                    content = content.replace(/<think>[\s\S]*?<\/think>/g, '');
                    // 清理多余的空行
                    content = content.replace(/^\s*\n+/g, '').trim();

                    // 记录过滤统计（用于调试）
                    const originalLength = arguments[0] ? arguments[0].length : 0;
                    const filteredLength = content.length;
                    if (originalLength > filteredLength) {
                        console.log(`🧠 DeepSeek NVIDIA: 过滤了 ${originalLength - filteredLength} 个思考过程字符`);
                    }
                }
                return content;
            }

            async function callAI(prompt, config) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };

                if (config.provider === 'openai' || config.provider === 'deepseek' || config.provider === 'deepseek-nvidia') {
                    headers['Authorization'] = `Bearer ${config.apiKey}`;
                }

                let messages = [{ role: 'user', content: prompt }];

                // 对于 DeepSeek NVIDIA 版，添加系统提示词禁用思考过程
                if (config.provider === 'deepseek-nvidia') {
                    messages = [
                        {
                            role: 'system',
                            content: '请直接回答问题，不要显示思考过程。不要使用 <think> 标签。'
                        },
                        { role: 'user', content: prompt }
                    ];
                }

                const requestBody = {
                    model: config.model,
                    messages: messages,
                    temperature: 0.5,
                    max_tokens: 800,
                    stream: false // 暂时关闭流式，因为需要解析完整响应
                };

                // 对于 DeepSeek NVIDIA 版，尝试添加禁用思考过程的参数
                if (config.provider === 'deepseek-nvidia') {
                    requestBody.reasoning = false; // 尝试禁用推理过程
                    requestBody.enable_thinking = false; // 尝试禁用思考过程
                }

                try {
                    const response = await fetch(`${config.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(requestBody),
                        mode: 'cors',
                        credentials: 'omit',
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`${response.status} ${errorData.error?.message || response.statusText}`);
                    }

                    const data = await response.json();

                    let content = data.choices[0]?.message?.content || '';

                    // 过滤思考过程
                    return filterThinkingProcess(content, config.provider);
                } catch (error) {
                    console.error('API调用失败:', error);

                    // 提供更详细的错误信息
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('网络连接失败，请检查网络设置或API地址是否正确');
                    } else if (error.message.includes('CORS')) {
                        throw new Error('跨域请求被阻止，请检查API服务器的CORS配置');
                    } else {
                        throw error;
                    }
                }
            }

            // 流式调用AI（用于回答问题）
            async function callAIStream(prompt, config, onChunk) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                };

                if (config.provider === 'openai' || config.provider === 'deepseek' || config.provider === 'deepseek-nvidia') {
                    headers['Authorization'] = `Bearer ${config.apiKey}`;
                }

                let messages = [{ role: 'user', content: prompt }];

                // 对于 DeepSeek NVIDIA 版，添加系统提示词禁用思考过程
                if (config.provider === 'deepseek-nvidia') {
                    messages = [
                        {
                            role: 'system',
                            content: '请直接回答问题，不要显示思考过程。不要使用 <think> 标签。'
                        },
                        { role: 'user', content: prompt }
                    ];
                }

                const requestBody = {
                    model: config.model,
                    messages: messages,
                    temperature: 0.6,
                    max_tokens: 1200,
                    stream: true
                };

                // 对于 DeepSeek NVIDIA 版，尝试添加禁用思考过程的参数
                if (config.provider === 'deepseek-nvidia') {
                    requestBody.reasoning = false;
                    requestBody.enable_thinking = false;
                }

                try {
                    const response = await fetch(`${config.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(requestBody),
                        mode: 'cors',
                        credentials: 'omit',
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`${response.status} ${errorData.error?.message || response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';
                    let buffer = '';

                    // DeepSeek NVIDIA 版的思考过程过滤状态
                    let isInThinkingProcess = false;
                    let thinkingBuffer = '';

                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');

                            // 保留最后一行（可能不完整）
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (trimmedLine.startsWith('data: ')) {
                                    const data = trimmedLine.slice(6).trim();

                                    if (data === '[DONE]') {
                                        // 最终过滤完整响应
                                        fullResponse = filterThinkingProcess(fullResponse, config.provider);
                                        return fullResponse;
                                    }

                                    if (data === '') continue;

                                    try {
                                        const parsed = JSON.parse(data);
                                        let content = parsed.choices?.[0]?.delta?.content || '';

                                        if (content) {
                                            fullResponse += content;

                                            // 对于 DeepSeek NVIDIA 版，实时过滤思考过程
                                            if (config.provider === 'deepseek-nvidia') {
                                                thinkingBuffer += content;

                                                // 检查是否进入思考过程
                                                if (!isInThinkingProcess && thinkingBuffer.includes('<think>')) {
                                                    isInThinkingProcess = true;
                                                    // 只输出 <think> 之前的内容
                                                    const beforeThink = thinkingBuffer.split('<think>')[0];
                                                    if (beforeThink) {
                                                        onChunk(beforeThink);
                                                    }
                                                    thinkingBuffer = '';
                                                }
                                                // 检查是否结束思考过程
                                                else if (isInThinkingProcess && thinkingBuffer.includes('</think>')) {
                                                    isInThinkingProcess = false;
                                                    // 输出 </think> 之后的内容
                                                    const afterThink = thinkingBuffer.split('</think>').slice(1).join('</think>');
                                                    if (afterThink) {
                                                        onChunk(afterThink);
                                                    }
                                                    thinkingBuffer = afterThink;
                                                }
                                                // 如果不在思考过程中，正常输出
                                                else if (!isInThinkingProcess) {
                                                    onChunk(content);
                                                    thinkingBuffer = '';
                                                }
                                                // 如果在思考过程中，不输出任何内容，只累积到buffer
                                            } else {
                                                // 其他提供商正常输出
                                                onChunk(content);
                                            }
                                        }
                                    } catch (e) {
                                        console.warn('解析流式数据失败:', e, '数据:', data);
                                    }
                                }
                            }
                        }
                    } finally {
                        reader.releaseLock();
                    }

                    // 最终过滤完整响应
                    fullResponse = filterThinkingProcess(fullResponse, config.provider);
                    return fullResponse;

                } catch (error) {
                    console.error('流式API调用失败:', error);

                    // 提供更详细的错误信息
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('网络连接失败，请检查网络设置或API地址是否正确');
                    } else if (error.message.includes('CORS')) {
                        throw new Error('跨域请求被阻止，请检查API服务器的CORS配置');
                    } else {
                        throw error;
                    }
                }
            }

            function parseQuestions(response, topic, startIndex) {
                const lines = response.split('\n').filter(line => line.trim());
                const questions = [];

                lines.forEach((line, index) => {
                    const trimmed = line.trim();

                    // 更宽松的匹配模式
                    if (/^\d+[.\s\-\):]/.test(trimmed) || /^[•\-\*]\s/.test(trimmed)) {
                        let question = trimmed.replace(/^\d+[.\s\-\):]*/, '').replace(/^[•\-\*]\s*/, '').trim();

                        // 清理问题格式：去掉多余的星号、方括号等格式符号
                        question = cleanQuestionFormat(question);

                        // 更宽松的长度要求
                        if (question.length > 3 && question.length < 200) {
                            questions.push({
                                id: startIndex + questions.length + 1,
                                question: question,
                                topic: topic,
                                answered: false,
                                answer: null,
                                category: getQuestionCategory(startIndex + questions.length, startIndex + 15)
                            });
                        }
                    }
                });

                // 如果解析失败，尝试按段落分割
                if (questions.length === 0) {
                    const paragraphs = response.split(/\n\s*\n/).filter(p => p.trim());
                    paragraphs.forEach((paragraph, index) => {
                        const cleaned = cleanQuestionFormat(paragraph.trim());
                        if (cleaned.length > 10 && cleaned.length < 200 && cleaned.includes('?') || cleaned.includes('？')) {
                            questions.push({
                                id: startIndex + questions.length + 1,
                                question: cleaned,
                                topic: topic,
                                answered: false,
                                answer: null,
                                category: getQuestionCategory(startIndex + questions.length, startIndex + 15)
                            });
                        }
                    });
                }

                return questions;
            }

            // 清理问题格式的函数
            function cleanQuestionFormat(question) {
                // 去掉开头和结尾的星号
                question = question.replace(/^\*+|\*+$/g, '');

                // 去掉【】符号，但保留内容
                question = question.replace(/【([^】]+)】/g, '$1');

                // 去掉多余的空格
                question = question.replace(/\s+/g, ' ').trim();

                // 如果问题被引号包围，去掉引号
                question = question.replace(/^["'"]|["'"]$/g, '');

                return question;
            }

            function getQuestionCategory(index, total) {
                const ratio = index / total;
                if (ratio < 0.3) return '基础入门';
                if (ratio < 0.7) return '实践应用';
                if (ratio < 0.9) return '进阶技能';
                return '行业洞察';
            }

            function displayQuestions(questions, topic) {
                const container = document.getElementById('questions-container');
                const list = document.getElementById('questions-list');
                const title = document.getElementById('questions-title');
                const stats = document.getElementById('question-stats');
                const loadMore = document.getElementById('load-more');

                title.textContent = `${topic} - 学习问题`;
                list.innerHTML = '';

                updateProgress();
                stats.style.display = 'flex';
                loadMore.style.display = 'block';



                questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    const hasApiKeyOrUnlimited = hasApiKey();
                    const isFreeQuestion = q.id <= 3;
                    const isAnswered = q.answer;

                    questionDiv.className = `question-card ${isAnswered ? 'answered' : ''} ${isAnswered ? 'clickable' : ''}`;

                    // 设置动画延时，让问题一条条扇入
                    questionDiv.style.animationDelay = `${index * 0.1} s`;

                    // 确定状态图标和问题状态
                    let statusIcon = '';
                    let questionStatus = '';

                    if (isAnswered) {
                        statusIcon = '<div class="question-status-icon answered-icon">✓</div>';
                        questionStatus = '已回答';
                    } else if (hasApiKeyOrUnlimited) {
                        // 有API密钥，所有问题都免费
                        statusIcon = '<div class="question-status-icon free-icon">免</div>';
                        questionStatus = '免费';
                    } else if (isFreeQuestion) {
                        // 前3个问题免费
                        statusIcon = '<div class="question-status-icon free-icon">免</div>';
                        questionStatus = '免费';
                    } else {
                        // 第4个问题开始，检查主题权限
                        const canUseTopic = canUseTopicForFree(q.topic);

                        if (canUseTopic) {
                            // 已解锁的主题
                            statusIcon = '<div class="question-status-icon free-icon">免</div>';
                            questionStatus = '已解锁';
                        } else {
                            // 需要付费
                            statusIcon = '<div class="question-status-icon paid-icon">💎</div>';
                            questionStatus = '付费';
                        }
                    }

                    questionDiv.innerHTML = `
                    ${statusIcon}
                    <div class="question-text">${q.question}</div>
                    <div class="question-footer">
                        <div class="question-meta">
                            问题 #${q.id} · ${questionStatus}
                        </div>
                        <div class="question-actions">
                            <button class="button button-small toggle-btn" title="${isAnswered ? '展开/收起答案' : '生成AI回答'}">
                                ${isAnswered ? '👁️ 展开' : '💡 回答'} 
                                <span class="category-badge" style="margin-left: 8px;">${q.category}</span>
                            </button>
                        </div>
                    </div>
                    <div class="answer-container" id="answer-${q.id}">
                        ${isAnswered ? `
                            <div class="answer-text">${renderMarkdown(q.answer)}</div>
                            <button class="collapse-btn" onclick="collapseAnswer(${q.id}, event)">📄 收起答案</button>
                        ` : ''}
                    </div>
            `;

                    // 添加事件监听器
                    const toggleBtn = questionDiv.querySelector('.toggle-btn');
                    console.log('Adding event listener for question', q.id, 'toggleBtn found:', !!toggleBtn);

                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', (e) => {
                            console.log('Toggle button clicked for question', q.id);
                            e.stopPropagation();
                            toggleAnswer(q.id);
                        });
                    }

                    // 已回答或正在生成中的问题卡片可以点击展开/收起
                    if (q.answer || q.isGenerating) {
                        questionDiv.classList.add('clickable');
                        questionDiv.addEventListener('click', () => {
                            toggleAnswerDisplay(q.id);
                        });
                    }

                    list.appendChild(questionDiv);
                });

                container.style.display = 'block';
                setTimeout(() => container.scrollIntoView({ behavior: 'smooth' }), 300);
            }

            function updateProgress() {
                const total = currentQuestions.length;
                const answered = currentQuestions.filter(q => q.answer).length;
                const percent = total > 0 ? Math.round((answered / total) * 100) : 0;

                document.getElementById('total-questions').textContent = total;
                document.getElementById('answered-questions').textContent = answered;
                document.getElementById('progress-percent').textContent = percent + '%';
            }

            // 新函数：只处理答案的展开/收起，不生成新答案
            function toggleAnswerDisplay(questionId) {
                console.log('toggleAnswerDisplay called with questionId:', questionId);
                const question = currentQuestions.find(q => q.id === questionId);
                console.log('question found:', !!question);
                const answerContainer = document.getElementById(`answer-${questionId}`);
                console.log('answerContainer found:', !!answerContainer);

                // 只有已有答案或正在生成中的问题才能展开/收起
                if (!question || (!question.answer && !question.isGenerating)) {
                    return;
                }

                // 安全地查找按钮
                let button = null;
                try {
                    if (answerContainer) {
                        const questionCard = answerContainer.closest('.question-card');
                        if (questionCard) {
                            button = questionCard.querySelector('.toggle-btn');
                        }
                    }
                } catch (e) {
                    console.warn('查找按钮失败:', e);
                }

                // 如果正在生成中，只允许展开/收起，不中断生成
                if (question.isGenerating) {
                    if (answerContainer.classList.contains('expanded')) {
                        answerContainer.classList.remove('expanded');
                        if (button) button.textContent = '👁️ 展开 (生成中)';
                    } else {
                        answerContainer.classList.add('expanded');
                        if (button) button.textContent = '⏳ 生成中';
                    }
                    return;
                }

                // 切换展开/收起
                if (answerContainer.classList.contains('expanded')) {
                    answerContainer.classList.remove('expanded');
                    if (button) button.textContent = '👁️ 展开';
                } else {
                    answerContainer.classList.add('expanded');
                    answerContainer.style.display = ''; // 确保显示
                    if (button) button.textContent = '👁️ 收起';
                }
            }

            async function toggleAnswer(questionId) {
                console.log('toggleAnswer called with questionId:', questionId);
                const question = currentQuestions.find(q => q.id === questionId);
                console.log('question found:', !!question);
                const answerContainer = document.getElementById(`answer-${questionId}`);
                console.log('answerContainer found:', !!answerContainer);

                // 安全地查找按钮
                let button = null;
                try {
                    if (answerContainer) {
                        const questionCard = answerContainer.closest('.question-card');
                        if (questionCard) {
                            button = questionCard.querySelector('.toggle-btn');
                        }
                    }
                } catch (e) {
                    console.warn('查找按钮失败:', e);
                }

                // 如果正在生成中，只允许展开/收起，不中断生成
                if (question.isGenerating) {
                    if (answerContainer.classList.contains('expanded')) {
                        answerContainer.classList.remove('expanded');
                        if (button) button.textContent = '👁️ 展开 (生成中)';
                    } else {
                        answerContainer.classList.add('expanded');
                        if (button) button.textContent = '⏳ 生成中';
                    }
                    return;
                }

                if (question.answer) {
                    // 已有答案，切换展开/收起
                    if (answerContainer.classList.contains('expanded')) {
                        answerContainer.classList.remove('expanded');
                        if (button) button.textContent = '👁️ 展开';
                    } else {
                        answerContainer.classList.add('expanded');
                        answerContainer.style.display = ''; // 确保显示
                        if (button) button.textContent = '👁️ 收起';
                    }
                    return;
                }

                // 生成新答案
                await generateAnswer(questionId);
            }

            async function regenerateAnswer(questionId) {
                if (isGenerating) return;
                const question = currentQuestions.find(q => q.id === questionId);
                question.answer = null;
                await generateAnswer(questionId, true);
            }

            // 创建友好的加载提示消息
            function createFriendlyLoadingMessage() {
                const loadingMessages = [
                    {
                        icon: '🤔',
                        text: 'AI正在深度思考中',
                        subtitle: '正在分析问题并整理最佳答案...'
                    },
                    {
                        icon: '📚',
                        text: '知识库检索中',
                        subtitle: '正在查找相关资料为您提供准确答案...'
                    },
                    {
                        icon: '✨',
                        text: '智能分析进行中',
                        subtitle: '正在运用AI算法生成个性化回答...'
                    },
                    {
                        icon: '🧠',
                        text: '大脑风暴中',
                        subtitle: '正在从多个角度思考这个问题...'
                    },
                    {
                        icon: '🔍',
                        text: '深度解析中',
                        subtitle: '正在为您准备详细而实用的解答...'
                    },
                    {
                        icon: '💡',
                        text: '灵感整理中',
                        subtitle: '正在将复杂概念转化为易懂的内容...'
                    }
                ];

                const randomMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];

                return `
                    <div class="loading">
                        <div class="loading-content">
                            <div class="loading-icon">${randomMessage.icon}</div>
                            <div class="loading-text">${randomMessage.text}</div>
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            <div class="loading-subtitle">${randomMessage.subtitle}</div>
                            <div class="thinking-progress">
                                <div class="thinking-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 更新加载提示（用于长时间等待）
            function updateLoadingMessage(container, duration) {
                const encouragingMessages = [
                    '正在精心准备答案，请稍等片刻...',
                    '好的内容需要时间，马上就好...',
                    '正在为您量身定制最佳回答...',
                    'AI正在努力思考，感谢您的耐心...',
                    '复杂问题需要深度思考，请稍候...',
                    '正在整合多方面知识为您服务...'
                ];

                if (duration > 10000) { // 10秒后显示鼓励消息
                    const messageIndex = Math.floor((duration - 10000) / 5000) % encouragingMessages.length;
                    const subtitleElement = container.querySelector('.loading-subtitle');
                    if (subtitleElement) {
                        subtitleElement.textContent = encouragingMessages[messageIndex];
                        subtitleElement.style.animation = 'fadeIn 0.5s ease-in-out';
                    }
                }
            }

            async function generateAnswer(questionId, isRegenerate = false) {
                const question = currentQuestions.find(q => q.id === questionId);
                const answerContainer = document.getElementById(`answer-${questionId}`);

                // 检查是否正在生成中，防止重复触发
                if (question.isGenerating) {
                    return;
                }

                // 设置生成状态
                question.isGenerating = true;

                // 简化按钮查找逻辑 - 使用更安全的方式
                let button = null;
                let questionCard = null;
                try {
                    if (answerContainer) {
                        questionCard = answerContainer.closest('.question-card');
                        if (questionCard) {
                            button = questionCard.querySelector('.toggle-btn');
                        }
                    }
                } catch (e) {
                    console.warn('查找按钮失败:', e);
                }

                // 为生成中的问题卡片添加点击事件（如果还没有的话）
                if (questionCard && !questionCard.hasAttribute('data-click-added')) {
                    questionCard.classList.add('clickable');
                    questionCard.addEventListener('click', (e) => {
                        // 如果点击的是按钮，不处理卡片点击
                        if (e.target.closest('.toggle-btn') || e.target.closest('.button')) {
                            return;
                        }
                        toggleAnswerDisplay(questionId);
                    });
                    questionCard.setAttribute('data-click-added', 'true');
                }

                // 定义一个安全的按钮文本更新函数
                function updateButtonText(text) {
                    if (button && button.textContent !== undefined) {
                        button.textContent = text;
                    }
                }

                // 检查是否有API密钥或主题权限
                if (!hasApiKey()) {
                    const isFreeQuestion = question.id <= 3; // 每个主题前3个问题免费
                    const canUseTopic = canUseTopicForFree(question.topic);

                    if (!isFreeQuestion && !canUseTopic) {
                        // 显示付费解锁界面
                        const userTopics = getUserTopics();
                        const usedTopics = getUsedTopics();

                        answerContainer.innerHTML = `
                            <div class="locked-answer">
                                <div class="locked-icon">🔒</div>
                                <div class="locked-text">需要解锁主题访问权限</div>
                                <div class="locked-subtitle">
                                    每个主题前3个问题免费，第${question.id}个问题需要主题权限<br>
                                    您可以配置自己的API密钥免费使用所有主题<br>
                                    或购买主题套餐解锁更多主题<br><br>
                                    当前状态：已使用 ${usedTopics.length} 个主题，剩余 ${userTopics === -1 ? '无限' : Math.max(0, userTopics - usedTopics.length)} 个主题
                                </div>
                                <div class="locked-buttons">
                                    <button class="unlock-btn" onclick="showPaymentModal()">
                                        💎 购买主题套餐
                                    </button>
                                    <button class="button button-small" onclick="showTab('settings')" style="background: #6B7280; margin-top: 15px;">
                                        ⚙️ 配置API密钥
                                    </button>
                                </div>
                        </div>
                    `;
                        answerContainer.classList.add('expanded');
                        updateButtonText('👁️ 收起');
                        return;
                    }

                    // 处理主题使用逻辑
                    if (isFreeQuestion) {
                        showMessage('免费问题，无需消耗主题权限', 'success');
                    } else if (canUseTopic) {
                        // 如果是新主题，标记为已使用
                        if (!isTopicUsed(question.topic)) {
                            markTopicAsUsed(question.topic);
                            const remainingTopics = getUserTopics();
                            const usedCount = getUsedTopics().length;
                            if (remainingTopics === -1) {
                                showMessage('使用无限主题权限回答问题', 'success');
                            } else {
                                showMessage(`使用主题权限回答问题，剩余 ${remainingTopics - usedCount} 个主题`, 'success');
                            }
                        } else {
                            showMessage('继续使用已解锁的主题', 'success');
                        }
                    }
                }

                // 创建友好的加载提示
                const loadingHTML = createFriendlyLoadingMessage();
                answerContainer.innerHTML = loadingHTML;
                answerContainer.classList.add('expanded');
                updateButtonText('⏳ 生成中');

                // 设置定时器来更新长时间等待的提示
                const startTime = Date.now();
                const loadingUpdateTimer = setInterval(() => {
                    const duration = Date.now() - startTime;
                    updateLoadingMessage(answerContainer, duration);
                }, 5000); // 每5秒更新一次

                try {
                    const saved = localStorage.getItem('api_config');
                    const config = JSON.parse(saved);

                    const prompt = generateAnswerPrompt(question);

                    let fullAnswer = '';

                    try {
                        // 尝试使用真正的流式输出
                        fullAnswer = await callAIStream(prompt, config, (chunk) => {
                            // 第一次收到数据时，清除加载提示并创建答案容器
                            if (fullAnswer === '') {
                                clearInterval(loadingUpdateTimer);
                                answerContainer.innerHTML = '<div class="answer-text"></div>';
                            }

                            fullAnswer += chunk;
                            const answerTextDiv = answerContainer.querySelector('.answer-text');
                            if (answerTextDiv) {
                                answerTextDiv.innerHTML = renderMarkdown(fullAnswer) + '<span class="streaming-cursor"></span>';
                            }
                        });

                        // 确保有答案容器
                        if (!answerContainer.querySelector('.answer-text')) {
                            clearInterval(loadingUpdateTimer);
                            answerContainer.innerHTML = '<div class="answer-text"></div>';
                        }

                        // 移除光标，显示最终结果
                        const answerTextDiv = answerContainer.querySelector('.answer-text');
                        if (answerTextDiv) {
                            answerTextDiv.innerHTML = renderMarkdown(fullAnswer);
                        }

                    } catch (streamError) {
                        console.warn('流式输出失败，使用普通模式:', streamError);

                        // 回退到普通模式 - 保持加载提示直到获得结果
                        fullAnswer = await callAI(prompt, config);

                        if (!fullAnswer || fullAnswer.trim().length === 0) {
                            throw new Error('AI返回空内容');
                        }

                        // 清除加载提示，显示结果
                        clearInterval(loadingUpdateTimer);
                        answerContainer.innerHTML = '<div class="answer-text"></div>';
                        const answerTextDiv = answerContainer.querySelector('.answer-text');
                        if (answerTextDiv) {
                            answerTextDiv.innerHTML = renderMarkdown(fullAnswer);
                        }
                    }

                    // 检查是否已经有收起按钮，避免重复添加
                    if (!answerContainer.querySelector('.collapse-btn')) {
                        answerContainer.innerHTML += `<button class="collapse-btn" onclick="collapseAnswer(${questionId}, event)">📄 收起答案</button>`;
                    }

                    question.answer = fullAnswer;
                    question.answered = true;
                    question.isGenerating = false; // 清除生成状态

                    // 更新问题卡片样式
                    const questionCard = answerContainer.closest('.question-card');
                    questionCard.classList.add('answered');
                    questionCard.classList.add('clickable');
                    questionCard.querySelector('.question-meta').innerHTML = `
                    <span class="category-badge">${question.category}</span>
                    问题 #${question.id} · 已回答
                `;

                    // 为问题卡片添加点击事件（只有展开/收起功能）
                    if (!questionCard.hasAttribute('data-click-added')) {
                        questionCard.addEventListener('click', (e) => {
                            // 如果点击的是按钮，不处理卡片点击
                            if (e.target.closest('.toggle-btn') || e.target.closest('.button')) {
                                return;
                            }
                            toggleAnswerDisplay(questionId);
                        });
                        questionCard.setAttribute('data-click-added', 'true');
                    }

                    updateButtonText('👁️ 收起');

                    updateProgress();
                    saveTopicCache(currentTopic, { questions: currentQuestions });
                    updateDashboard();

                    // 保存到问答历史
                    saveToHistory(question.question, fullAnswer, question.topic);

                    if (isRegenerate) {
                        showMessage('答案已重新生成', 'success');
                    }

                } catch (error) {
                    clearInterval(loadingUpdateTimer); // 清除定时器
                    question.isGenerating = false; // 清除生成状态
                    answerContainer.innerHTML = `
                    <div style="color: #DC2626; padding: 15px; background: #FEE2E2; border-radius: 8px;">
                        ❌ 回答失败: ${error.message}
                        <br><br>
                        <button class="button button-small" onclick="generateAnswer(${questionId})" style="margin-top: 10px;">🔄 重试</button>
                    </div>
                `;
                    updateButtonText('💡 回答');
                }
            }

            // 优化的Markdown渲染器 - 专为学习内容优化
            function renderMarkdown(text) {
                // 首先清理不必要的代码性字符
                text = cleanAnswerFormat(text);

                return text
                    // 标题
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    // 粗体和斜体
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    // 只保留必要的代码格式（单行代码）
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    // 链接
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    // 列表
                    .replace(/^\* (.*$)/gim, '<li>$1</li>')
                    .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
                    // 引用
                    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                    // 段落
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/^(.*)$/gim, '<p>$1</p>')
                    // 清理多余的p标签
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p>(<h[1-6]>.*<\/h[1-6]>)<\/p>/g, '$1')
                    .replace(/<p>(<li>.*<\/li>)<\/p>/g, '<ul>$1</ul>')
                    .replace(/<p>(<blockquote>.*<\/blockquote>)<\/p>/g, '$1');
            }

            // 清理答案格式的函数
            function cleanAnswerFormat(text) {
                // 去掉代码块标记
                text = text.replace(/```[\w]*\n?/g, '');
                text = text.replace(/```/g, '');

                // 去掉多余的分隔线
                text = text.replace(/^-{3,}$/gm, '');
                text = text.replace(/^={3,}$/gm, '');

                // 去掉mermaid图表标记
                text = text.replace(/```mermaid[\s\S]*?```/g, '');

                // 去掉其他代码语言标记
                text = text.replace(/'''(python|javascript|java|html|css|sql|json|xml|yaml)[\s\S]*?'''/g, '');

                // 清理Markdown标题语法残留
                text = text.replace(/^#{1,6}\s*/gm, '');

                // 清理列表标记残留（保留内容，只去掉标记）
                text = text.replace(/^\s*[-*+]\s+/gm, '• ');
                text = text.replace(/^\s*\d+\.\s+/gm, (match, offset, string) => {
                    // 保留数字列表的数字，但简化格式
                    const num = match.match(/\d+/)[0];
                    return `${num}. `;
                });

                // 清理多余的空行
                text = text.replace(/\n{3,}/g, '\n\n');

                // 去掉开头和结尾的空白
                text = text.trim();

                return text;
            }

            // 验证和处理主题函数
            async function validateAndProcessTopic(topic) {
                try {
                    // 检查主题是否已在主题库中
                    const allTopics = Object.values(industryTopics).flat();
                    if (allTopics.includes(topic)) {
                        return { isValid: true, optimizedTopic: topic };
                    }

                    // 检查是否已经验证过的主题（缓存验证结果）
                    const validatedTopics = JSON.parse(localStorage.getItem('validated_topics') || '{}');
                    if (validatedTopics[topic]) {
                        return validatedTopics[topic];
                    }

                    // 优先使用简单验证，避免每次都调用AI
                    const simpleValidation = validateTopicSimple(topic);
                    if (simpleValidation.isValid) {
                        // 缓存验证结果
                        validatedTopics[topic] = simpleValidation;
                        localStorage.setItem('validated_topics', JSON.stringify(validatedTopics));
                        return simpleValidation;
                    }

                    // 只有在简单验证失败时才使用AI验证
                    const config = JSON.parse(localStorage.getItem('api_config') || '{}');
                    if (!config.apiKey) {
                        return simpleValidation;
                    }

                    let validationPrompt = `请分析并优化以下用户输入，将其转换为更适合学习的主题：

用户输入：${topic}

请按以下格式回复：
验证结果：适合/不适合
优化主题：[改写后的学习主题名称]
学科领域：[所属学科分类]
优化说明：[简要说明优化的原因]

优化要求：
1. 如果用户输入模糊或口语化，请改写为更具体、更学术的表达
2. 如果用户输入过于宽泛，请细化为具体的学习方向
3. 如果用户输入包含"我想学"、"怎么"等口语表达，请提取核心学习内容
4. 确保优化后的主题适合生成结构化的学习问题
5. 保持主题的核心意图不变，只优化表达方式

示例：
- "我想学做菜" → "烹饪技巧与营养搭配"
- "怎么赚钱" → "个人理财与投资基础"
- "AI" → "人工智能基础原理与应用"
- "编程" → "程序设计基础与实践"`;

                    // 为 DeepSeek NVIDIA 版添加思考过程屏蔽
                    if (config.provider === 'deepseek-nvidia') {
                        validationPrompt += `<|beginning of thinking|>Okay, I think I have finished thinking.<|end of thinking|>`;
                    }

                    const response = await callAI(validationPrompt, config);
                    const aiValidation = parseTopicValidation(response, topic);

                    // 缓存AI验证结果
                    validatedTopics[topic] = aiValidation;
                    localStorage.setItem('validated_topics', JSON.stringify(validatedTopics));

                    return aiValidation;

                } catch (error) {
                    console.error('主题验证失败:', error);
                    // 如果AI验证失败，使用简单验证
                    return validateTopicSimple(topic);
                }
            }

            // 简单主题验证（不使用AI）
            function validateTopicSimple(topic) {
                // 检查是否包含不适合学习的关键词
                const invalidKeywords = ['色情', '暴力', '赌博', '毒品', '政治敏感', '违法', '犯罪'];
                const lowerTopic = topic.toLowerCase();

                for (const keyword of invalidKeywords) {
                    if (lowerTopic.includes(keyword)) {
                        return {
                            isValid: false,
                            message: '该主题不适合作为学习内容，请选择其他主题'
                        };
                    }
                }

                // 检查主题长度
                if (topic.length < 2) {
                    return {
                        isValid: false,
                        message: '主题名称过短，请输入更具体的学习主题'
                    };
                }

                if (topic.length > 50) {
                    return {
                        isValid: false,
                        message: '主题名称过长，请简化主题描述'
                    };
                }

                return { isValid: true, optimizedTopic: topic };
            }

            // 解析AI的主题验证结果
            function parseTopicValidation(response, originalTopic) {
                try {
                    const lines = response.split('\n').map(line => line.trim()).filter(line => line);
                    let isValid = false;
                    let optimizedTopic = originalTopic;
                    let category = '';
                    let explanation = '';

                    for (const line of lines) {
                        if (line.includes('验证结果：')) {
                            isValid = line.includes('适合');
                        } else if (line.includes('优化主题：')) {
                            const match = line.match(/优化主题：(.+)/);
                            if (match) {
                                optimizedTopic = match[1].trim();
                                // 清理可能的方括号
                                optimizedTopic = optimizedTopic.replace(/^\[|\]$/g, '');
                            }
                        } else if (line.includes('学科领域：')) {
                            const match = line.match(/学科领域：(.+)/);
                            if (match) {
                                category = match[1].trim();
                                // 清理可能的方括号
                                category = category.replace(/^\[|\]$/g, '');
                            }
                        } else if (line.includes('优化说明：')) {
                            const match = line.match(/优化说明：(.+)/);
                            if (match) explanation = match[1].trim();
                        }

                        // 兼容旧格式
                        else if (line.includes('适合性：')) {
                            isValid = line.includes('是');
                        } else if (line.includes('说明：')) {
                            const match = line.match(/说明：(.+)/);
                            if (match) explanation = match[1].trim();
                        }
                    }

                    if (!isValid) {
                        return {
                            isValid: false,
                            message: explanation || '该主题不适合作为学习内容，请选择其他主题'
                        };
                    }

                    // 如果主题被优化且不在主题库中，考虑添加到自定义主题
                    if (optimizedTopic !== originalTopic || !Object.values(industryTopics).flat().includes(optimizedTopic)) {
                        addCustomTopic(optimizedTopic, category);
                    }

                    return {
                        isValid: true,
                        optimizedTopic: optimizedTopic,
                        category: category,
                        explanation: explanation
                    };

                } catch (error) {
                    console.error('解析主题验证结果失败:', error);
                    return { isValid: true, optimizedTopic: originalTopic };
                }
            }

            // 添加自定义主题到主题库
            function addCustomTopic(topic, category) {
                // 所有自定义主题统一归类到一个简短的分类下
                const targetCategory = '⭐ 我的主题';

                // 如果目标分类不存在，创建自定义分类
                if (!industryTopics[targetCategory]) {
                    industryTopics[targetCategory] = [];
                }

                // 检查主题是否已存在
                if (!industryTopics[targetCategory].includes(topic)) {
                    industryTopics[targetCategory].push(topic);

                    // 保存到本地存储
                    const customTopics = JSON.parse(localStorage.getItem('custom_topics') || '{}');
                    if (!customTopics[targetCategory]) {
                        customTopics[targetCategory] = [];
                    }
                    if (!customTopics[targetCategory].includes(topic)) {
                        customTopics[targetCategory].push(topic);
                        localStorage.setItem('custom_topics', JSON.stringify(customTopics));
                    }

                    // 刷新主题库显示
                    renderIndustryTopics();

                    console.log(`已添加自定义主题"${topic}"到"我的主题"`);

                    // 显示成功提示
                    showMessage(`✨ 已将"${topic}"添加到我的主题`, 'success');
                }
            }

            // 加载自定义主题
            function loadCustomTopics() {
                const customTopics = JSON.parse(localStorage.getItem('custom_topics') || '{}');

                for (const [category, topics] of Object.entries(customTopics)) {
                    if (!industryTopics[category]) {
                        industryTopics[category] = [];
                    }

                    for (const topic of topics) {
                        if (!industryTopics[category].includes(topic)) {
                            industryTopics[category].push(topic);
                        }
                    }
                }
            }

            // 收起答案函数
            function collapseAnswer(questionId, event) {
                // 阻止事件冒泡，防止触发其他点击事件
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }

                console.log('collapseAnswer called with questionId:', questionId);

                const answerContainer = document.getElementById(`answer-${questionId}`);
                console.log('answerContainer found:', !!answerContainer);

                if (!answerContainer) {
                    console.error('Answer container not found for question:', questionId);
                    return;
                }

                // 收起答案容器
                answerContainer.classList.remove('expanded');
                console.log('Removed expanded class from answer container');

                // 查找对应的问题卡片和按钮
                const questionCard = answerContainer.closest('.question-card');
                console.log('questionCard found:', !!questionCard);

                if (questionCard) {
                    const toggleBtn = questionCard.querySelector('.toggle-btn');
                    console.log('toggleBtn found:', !!toggleBtn);

                    if (toggleBtn) {
                        // 更新按钮文本，移除category-badge来获取纯文本
                        const categoryBadge = toggleBtn.querySelector('.category-badge');
                        const categoryText = categoryBadge ? categoryBadge.outerHTML : '';

                        const question = currentQuestions.find(q => q.id === questionId);
                        if (question && question.answer) {
                            toggleBtn.innerHTML = `👁️ 展开 ${categoryText}`;
                            console.log('Updated button text to 展开');
                        } else {
                            toggleBtn.innerHTML = `💡 回答 ${categoryText}`;
                            console.log('Updated button text to 回答');
                        }
                    } else {
                        console.error('Toggle button not found in question card');
                    }
                } else {
                    console.error('Question card not found');
                }
            }

            function showMessage(message, type) {
                const existing = document.querySelector('.message');
                if (existing) existing.remove();

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;

                document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.tabs'));

                if (type === 'success' || type === 'loading') {
                    setTimeout(() => {
                        if (messageDiv.parentNode) messageDiv.remove();
                    }, type === 'success' ? 3000 : 10000);
                }
            }

            // 卡片3D点击效果
            function initFeatureCardEffects() {
                const featureItems = document.querySelectorAll('.feature-item');

                featureItems.forEach(item => {
                    item.addEventListener('click', function (e) {
                        e.preventDefault();

                        // 如果已经是点击状态，则还原
                        if (this.classList.contains('clicked')) {
                            this.classList.remove('clicked');
                        } else {
                            // 先移除其他卡片的点击状态
                            featureItems.forEach(otherItem => {
                                otherItem.classList.remove('clicked');
                            });

                            // 添加点击状态
                            this.classList.add('clicked');

                            // 添加轻微震动效果
                            this.style.animation = 'cardPulse 0.3s ease-out';
                            setTimeout(() => {
                                this.style.animation = '';
                            }, 300);
                        }
                    });

                    // 添加触摸支持
                    item.addEventListener('touchstart', function (e) {
                        e.preventDefault();
                        this.click();
                    });
                });
            }

            // 启动页面控制函数
            function hideSplashScreen() {
                const splashScreen = document.getElementById('splash-screen');
                const mainApp = document.getElementById('main-app');

                // 添加淡出效果
                splashScreen.classList.add('fade-out');

                // 延迟显示主应用
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainApp.classList.add('show');
                    // 确保页面滚动到顶部
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                }, 800);
            }

            // 页面加载完成后的初始化
            document.addEventListener('DOMContentLoaded', function () {
                // 确保启动页面显示，主应用隐藏
                document.getElementById('splash-screen').style.display = 'flex';
                document.getElementById('main-app').classList.remove('show');

                // 初始化卡片3D点击效果
                initFeatureCardEffects();
            });
        </script>
    </div>
    </div>
</body>

</html>